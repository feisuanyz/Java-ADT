### 2. 电商平台应用

#### 2.2 基于Redis的分布式锁实现

为了对某一个共享变量进行多线程同步访问，同时保证该共享变量在高并发情况下的同一时间只能被一个线程执行，我们经常需要用到分布式锁。本案例将模拟多用户下单减少商品库存数量的场景为您介绍如何使用全自动开发平台实现分布式锁功能。由于Redis具有性能高、使用方便等功能特点，较为适用于分布式锁功能，故本案例将基于Redis实现。常见的应用场景有：电商平台商品秒杀、抢优惠券等。

##### 说明：案例使用全自动测试平台进行测试，全自动测试平台是我司自主开发的全自动软件工程平台中第二个实用的平台，覆盖了整个软件测试的生命周期管理，包含测试用例管理、测试计划管理、接口测试、性能测试等功能，可以一键关联和同步全自动开发平台的项目和项目中所有的接口信息。

##### 2.2.1 效果展示

本案例设置的商品初始化库存数量为10，调用初始化库存接口后，在全自动测试平台进行性能测试，设置12个并发用户同时发送下单请求（即调用分布式锁接口），此时性能测试报告显示：12个请求中，10个请求输出“调用成功”，2个请求输出“库存不足”，如图2-41所示：

![2-41](https://www.feisuanyz.com/fsimage/alcj-image/redislock/2-1.png)

##### 图2-41 性能测试报告

##### 2.2.2 流程图设计概览

a）初始化库存接口

![2-42](https://www.feisuanyz.com/fsimage/alcj-image/redislock/3-1.png)

##### 图2-42 流程图

逻辑描述：a1）在Redis缓存上储存初始化库存量，并设置初始化库存量为10；a2） 获取Redis缓存上储存的初始化库存量；a3） 输出Redis缓存上储存的初始化库存量。

b）初始化库存接口

![2-43](https://www.feisuanyz.com/fsimage/alcj-image/redislock/3-2.png)

##### 图2-43 流程图

逻辑描述：a1）构建分布式锁Map集合；a2）上锁，设置超时释放时间；a3）获取Redis缓存上存储的当前库存量；a4） 判断当前库存量是否小于等于0，若小于等于0，说明库存量不足，则输出库存不足；若大于0，说明库存量充足，则继续以下流程；a5）将当前库存量减1，并更新Redis缓存上存储的库存量；a6）再次获取更新后Redis缓存上的库存量；a7）输出现存库存量。

c）分布式锁接口

![2-44](https://www.feisuanyz.com/fsimage/alcj-image/redislock/3-2.png)

##### 图2-44 流程图

逻辑描述：a1）构建分布式锁Map集合；a2）上锁，设置超时释放时间；a3）获取Redis缓存上存储的当前库存量；a4）判断当前库存量是否小于等于0，若小于等于0，说明库存量不足，则输出库存不足；若大于0，说明库存量充足，则继续以下流程；a5）将当前库存量减1，并更新Redis缓存上存储的库存量；a6）再次获取更新后Redis缓存上的库存量；a7）输出现存库存量。

##### 2.2.2 全自动开发平台操作步骤

##### 前提条件：您需要确保项目中已添加Redis缓存加载项，关于如何加载资源可参见[《SoFlu社区版快速入门教程第4.9节：如何加载资源》](https://gitee.com/feisuanyz/SoFlu-adp/blob/master/SoFlu%E7%A4%BE%E5%8C%BA%E7%89%88%E6%95%99%E7%A8%8B/SoFlu%E7%A4%BE%E5%8C%BA%E7%89%88%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/SoFlu%E7%A4%BE%E5%8C%BA%E7%89%88%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B.md#49-%E5%A6%82%E4%BD%95%E5%8A%A0%E8%BD%BD%E8%B5%84%E6%BA%90)。

a）创建Redis缓存资源实例

![2-45](https://www.feisuanyz.com/fsimage/alcj-image/redislock/4-1.png)

##### 图2-45 新增Redis缓存资源实例

b）创建初始化库存接口

b1）进入全自动开发平台“接口管理”功能模块，新增接口模块并新增初始化库存接口，填写接口的基本信息，如图2-46所示：

![2-46](https://www.feisuanyz.com/fsimage/alcj-image/redislock/4-2.png)

##### 图2-46 点击“接口管理”

![2-47](https://www.feisuanyz.com/fsimage/alcj-image/redislock/4-3.png)

##### 图2-47 填写接口的基本信息

b2）单击“下一步”，该接口不需要配置参数信息，直接提交接口信息，进入模型编辑，如图2-47所示：

![2-47](https://www.feisuanyz.com/fsimage/alcj-image/redislock/4-4.png)

##### 图2-47 进入模型编辑

b3）在窗体视图页面，通过拖拽左侧组件列表中所需的组件进行流程图编辑，如图2-48所示：

![2-48](https://www.feisuanyz.com/fsimage/alcj-image/redislock/4-5.png)

##### 图2-48 进行流程图编辑

c）初始化库存接口中组件的详细配置

c1）在Redis缓存上储存初始化库存量，并设置初始化库存量为10。

使用Redis组件调用Redis方法putBucket(String name, Object value)新增通用对象，用于表示初始化的库存量，传入通用对象名stock以及通用对象参数值10即可，如图2-49、图2-50所示：

![2-49](https://www.feisuanyz.com/fsimage/alcj-image/redislock/4-6.png)

##### 图2-49 Redis组件【初始化库存数量10】

![2-50](https://www.feisuanyz.com/fsimage/alcj-image/redislock/4-7.png)

##### 图2-50 组件配置

##### 说明：此处用到的Redis方法类型为Bucket，专门用于操作通用对象，putBucket方法说明如图2-51所示：

![2-51](https://www.feisuanyz.com/fsimage/alcj-image/redislock/table1.png)

##### 图2-51 putBucket方法说明

c2）使用Redis组件调用Redis方法getBucket(String name)获取Redis缓存上储存的初始化库存量，传入通用对象名stock即可，如图2-52、图2-53所示：

![2-52](https://www.feisuanyz.com/fsimage/alcj-image/redislock/4-8.png)

##### 图2-52 Redis缓存组件【获取初始化库存量】

![2-53](https://www.feisuanyz.com/fsimage/alcj-image/redislock/4-9.png)

##### 图2-53 组件配置

c3）使用输出结果组件输出Redis缓存上储存的初始化库存量，传入Redis组件【获取初始化库存量】的执行结果即可，如图2-54、图2-55所示：

![2-54](https://www.feisuanyz.com/fsimage/alcj-image/redislock/4-10.png)

##### 图2-54 输出结果【输出初始化库存量】

![2-55](https://www.feisuanyz.com/fsimage/alcj-image/redislock/4-11.png)

##### 图2-55 组件配置

d）测试初始化库存接口

d1）流程图设计完成后，保存并退出窗体视图，如图2-56所示：

![2-56](https://www.feisuanyz.com/fsimage/alcj-image/redislock/4-12.png)

##### 图2-56 保存并退出窗体

d2）提交并发布接口，如图2-57所示：

![2-57](https://www.feisuanyz.com/fsimage/alcj-image/redislock/4-13.png)

##### 图2-57 提交并发布接口

d3）对接口进行测试用例，检验接口实现的功能是否可以达到预期，如图2-58所示：

![2-58](https://www.feisuanyz.com/fsimage/alcj-image/redislock/4-14.png)

##### 图2-58 使用测试用例

d4）执行测试用例，如图2-59所示：

![2-59](https://www.feisuanyz.com/fsimage/alcj-image/redislock/4-15.png)
