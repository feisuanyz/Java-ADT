### 2. 电商平台应用

#### 2.2 基于Redis的分布式锁实现

为了对某一个共享变量进行多线程同步访问，同时保证该共享变量在高并发情况下的同一时间只能被一个线程执行，我们经常需要用到分布式锁。本案例将模拟多用户下单减少商品库存数量的场景为您介绍如何使用全自动开发平台实现分布式锁功能。由于Redis具有性能高、使用方便等功能特点，较为适用于分布式锁功能，故本案例将基于Redis实现。常见的应用场景有：电商平台商品秒杀、抢优惠券等。

##### 说明：案例使用全自动测试平台进行测试，全自动测试平台是我司自主开发的全自动软件工程平台中第二个实用的平台，覆盖了整个软件测试的生命周期管理，包含测试用例管理、测试计划管理、接口测试、性能测试等功能，可以一键关联和同步全自动开发平台的项目和项目中所有的接口信息。

##### 2.2.1 效果展示

本案例设置的商品初始化库存数量为10，调用初始化库存接口后，在全自动测试平台进行性能测试，设置12个并发用户同时发送下单请求（即调用分布式锁接口），此时性能测试报告显示：12个请求中，10个请求输出“调用成功”，2个请求输出“库存不足”，如图2-41所示：

![2-41](https://www.feisuanyz.com/fsimage/alcj-image/redislock/2-1.png)

##### 图2-41 性能测试报告

##### 2.2.2 流程图设计概览

a）初始化库存接口

![2-42](https://www.feisuanyz.com/fsimage/alcj-image/redislock/3-1.png)

##### 图2-42 流程图

逻辑描述：a1）在Redis缓存上储存初始化库存量，并设置初始化库存量为10；a2） 获取Redis缓存上储存的初始化库存量；a3） 输出Redis缓存上储存的初始化库存量。

b）初始化库存接口

![2-43](https://www.feisuanyz.com/fsimage/alcj-image/redislock/3-2.png)

##### 图2-43 流程图

逻辑描述：a1）构建分布式锁Map集合；a2）上锁，设置超时释放时间；a3）获取Redis缓存上存储的当前库存量；a4） 判断当前库存量是否小于等于0，若小于等于0，说明库存量不足，则输出库存不足；若大于0，说明库存量充足，则继续以下流程；a5）将当前库存量减1，并更新Redis缓存上存储的库存量；a6）再次获取更新后Redis缓存上的库存量；a7）输出现存库存量。

c）分布式锁接口

![2-44](https://www.feisuanyz.com/fsimage/alcj-image/redislock/3-2.png)

##### 图2-44 流程图

逻辑描述：a1）构建分布式锁Map集合；a2）上锁，设置超时释放时间；a3）获取Redis缓存上存储的当前库存量；a4）判断当前库存量是否小于等于0，若小于等于0，说明库存量不足，则输出库存不足；若大于0，说明库存量充足，则继续以下流程；a5）将当前库存量减1，并更新Redis缓存上存储的库存量；a6）再次获取更新后Redis缓存上的库存量；a7）输出现存库存量。

##### 2.2.2 全自动开发平台操作步骤

##### 前提条件：您需要确保项目中已添加Redis缓存加载项，关于如何加载资源可参见[《SoFlu社区版快速入门教程第4.9节：如何加载资源》](https://gitee.com/feisuanyz/SoFlu-adp/blob/master/SoFlu%E7%A4%BE%E5%8C%BA%E7%89%88%E6%95%99%E7%A8%8B/SoFlu%E7%A4%BE%E5%8C%BA%E7%89%88%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/SoFlu%E7%A4%BE%E5%8C%BA%E7%89%88%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B.md#49-%E5%A6%82%E4%BD%95%E5%8A%A0%E8%BD%BD%E8%B5%84%E6%BA%90)。

a）创建Redis缓存资源实例

![2-45](https://www.feisuanyz.com/fsimage/alcj-image/redislock/4-1.png)

##### 图2-45 新增Redis缓存资源实例
