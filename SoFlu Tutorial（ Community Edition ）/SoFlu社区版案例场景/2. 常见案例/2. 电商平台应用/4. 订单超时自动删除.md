### 2. 电商平台应用

#### 2.4 订单超时自动删除

日常生活中，我们经常需要使用到电商平台，例如淘宝、京东、拼多多等。在这些交易场景下的订单一般会设置一个支付时间，若超过这个支付时间，该订单将自动取消并删除（或订单状态变为已过期）。

在本节案例中，我们将使用全自动开发平台实现订单超时自动删除功能。相比于传统开发，利用全自动开发平台可视化开发功能，将功能的实现逻辑在流程图中展示，开发过程变得更加简洁。

##### 2.4.1 效果展示

在全自动开发平台中，执行“订单超时自动删除”定时任务，系统将弹出调用成功的详情页面。若data输出“0”，则说明没有需要删除的订单；若data输出1，则说明删除了1条超时订单；以此类推data输出3即说明删除了3条超时订单，如图2-176所示。此时数据库中的订单表有如下变化：未支付且超过规定支付时间的订单将会自动删除，如图2-177、2-178所示：

![2-176](https://www.feisuanyz.com/fsimage/alcj-image/orderdelete/2-1.jpeg)

##### 图2-176 定时任务调用详情页面

![2-177](https://www.feisuanyz.com/fsimage/alcj-image/orderdelete/2-2.png)

##### 图2-177 调用定时任务前订单表数据

![2-178](https://www.feisuanyz.com/fsimage/alcj-image/orderdelete/2-3.png)

##### 图2-178 调用定时任务后订单表数据

##### 说明：本案例仅针对后端程序开发，若与前端页面联调可实现如图2-179、图2-180所展示的效果，此处以淘宝平台为例：

![2-179](https://www.feisuanyz.com/fsimage/alcj-image/orderdelete/2-4.png)

##### 图2-179 执行前前端页面效果

![2-180](https://www.feisuanyz.com/fsimage/alcj-image/orderdelete/2-5.png)

##### 图2-180 执行后前端页面效果

##### 2.4.2 准备工作

提前准备一张数据表：订单表 order_info（用于存储订单信息），表结构设计及相关数据如图2-181所示：

订单表 order_info：

```
CREATE TABLE `order_info` (
  `order_id` varchar(24) NOT NULL DEFAULT '' COMMENT '订单号',
  `customer_id` varchar(9) DEFAULT NULL COMMENT '客户编号',
  `pay_money` decimal(12,2) DEFAULT NULL COMMENT '支付金额',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',   
  `pay_status` int(11) DEFAULT NULL COMMENT '支付状态',   
  PRIMARY KEY (`order_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='订单表';
```
##### 说明：订单表中的数据可以自行配置，其中pay_status（支付状态）为1时表示订单已支付，为0时表示订单未支付。

![2-181](https://www.feisuanyz.com/fsimage/alcj-image/orderdelete/3-1.png)

##### 图2-181 订单表数据

##### 2.4.3 流程图设计概览

![2-182](https://www.feisuanyz.com/fsimage/alcj-image/orderdelete/4-1.png)

##### 图2-182 定时任务流程图

逻辑描述：

a）将“需删除的未支付且超过支付时间的订单数目”初始化设置为0；

b）在<订单表>查询未支付订单信息；

c）获取<订单表>中未支付订单的总数；

d）遍历查询到的未支付订单信息，若当前计数器索引值小于未支付订单总数，则开始遍历流程；若当前计数器索引值大于等于未支付订单总数，则进行遍历完成流程；

e）开始遍历流程：

e1）获取当前计数器索引值指向未支付订单的最后支付时间（即订单创建时间加上30分钟）；

e2）获取当前系统时间；

e3）判断当前未支付订单是否支付超时，若支付超时，即当前未支付订单的最后支付时间小于等于当前系统时间，则进行支付超时流程；若支付未超时，即当前未支付订单的最后支付时间大于当前系统时间，继续遍历下一条数据；

e4）支付超时流程：删除当前未支付订单；

e5）支付超时流程：需删除的未支付且超过支付时间的订单数目加1，继续遍历下一条数据；

f）遍历完成流程：输出需删除的未支付且超过支付时间的订单数目，结束流程。

##### 2.4.3 全自动开发平台操作步骤：

a）新增实体模型count
