### 6. 系统站内信推送

#### 6.1 系统站内信推送

系统推送站内信是系统开发中比较常用的功能，后端实现推送站内信的功能是将数据存储到数据库中（新增系统消息表），以方便前端页面调用数据，本节讲述如何使用全自动开发平台开发系统站内信后端功能。

##### 6.1.1 效果展示

![6-1](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/1.png)

##### 图6-1 APP消息模块推送消息界面

上图是APP消息模块推送手工消息的界面展示效果，对于后端开发来说，只需要将数据存储到<系统消息表>中即可，如图6-2所示：

![6-2](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/2.png)

##### 图6-2 系统消息表

##### 6.1.2 准备工作

需提前准备功能实现过程中用到的两张数据表：消息推送节点表 bs_message_node（用来存储消息模版消息）、系统消息表sy_message（用来存储推送消息），表结构设计及相关数据如下图所示：

消息推送节点表 bs_message_node：

```
CREATE TABLE `bs_message_node` (
  `send_node_id` varchar(50) NOT NULL COMMENT '推送节点编号',
  `send_node_name` varchar(100) DEFAULT NULL COMMENT '推送节点名称',
  `send_context` varchar(200) DEFAULT NULL COMMENT '推送内容',
  `message_title` varchar(200) DEFAULT NULL COMMENT '消息标题',
  `message_type` int(11) DEFAULT NULL COMMENT '消息类型',
  `goto_type` int(11) DEFAULT NULL COMMENT '跳转类别',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  PRIMARY KEY (`send_node_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='消息推送节点表';
```

![6-3](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/3.png)

##### 图6-3 消息推送节点表

消息推送节点表 bs_message_node：


```
CREATE TABLE `bs_message_node` (
  `send_node_id` varchar(50) NOT NULL COMMENT '推送节点编号',
  `send_node_name` varchar(100) DEFAULT NULL COMMENT '推送节点名称',
  `send_context` varchar(200) DEFAULT NULL COMMENT '推送内容',
  `message_title` varchar(200) DEFAULT NULL COMMENT '消息标题',
  `message_type` int(11) DEFAULT NULL COMMENT '消息类型',
  `goto_type` int(11) DEFAULT NULL COMMENT '跳转类别',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  PRIMARY KEY (`send_node_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='消息推送节点表';
```

系统消息表sy_message:

```
CREATE TABLE `sy_message` (
  `msg_id` varchar(24) COLLATE utf8_bin NOT NULL COMMENT '消息编号',
  `is_readed` int(11) DEFAULT NULL COMMENT '是否已查阅',
  `title` varchar(100) COLLATE utf8_bin DEFAULT NULL COMMENT '消息标题',
  `context` varchar(100) COLLATE utf8_bin DEFAULT NULL COMMENT '消息内容',
  `message_type` int(11) DEFAULT NULL COMMENT '消息类型',
  `goto_type` int(11) DEFAULT NULL COMMENT '跑转类别',
  `relation_id` varchar(24) COLLATE utf8_bin DEFAULT NULL COMMENT '关联编号',
  `receive_user` varchar(24) COLLATE utf8_bin DEFAULT NULL COMMENT '接收人',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `create_user` varchar(24) COLLATE utf8_bin DEFAULT NULL COMMENT '创建人',
 PRIMARY KEY (`msg_id`)
 )ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='系统消息表';
```

![6-4](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/4.png)

##### 图6-4 系统消息表

##### 6.1.3 流程图设计概述

![6-5](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/5.png)

##### 图6-5 流程图

逻辑概述：

a）系统消息分为系统自动发送的消息和管理员手工发送的消息，通过sendNodeId(推送节点编号)来判断推送消息方式，为空发送手工消息，不为空发送模版消息。

b）发送手工消息时，通过赋值组件对SyMessage实体模型字段进行赋值，然后调用新增SQL对表进行批量新增操作。

c）发送模版消息时，需要先根据sendNodeId(推送节点编号)查询<消息推送节点表 bs_message_node>中的message_title、message_type、send_context、goto_type字段信息。

d）使用按模板生成文本内容函数，将查询到的send_context内容中的‘{}’参数用入参params参数列表替换文本，然后赋值到SyMessage实体模型，根据不同接收人，将各个不同map放到一个初始化list中，最后执行批量新增SQL操作。

##### 6.1.4 技术要点概述

本实例涉及单函数、多函数、互斥条件、计数器、单SQL等组件，需要对参数进行处理后赋值给<系统消息表>的实体模型，最后执行新增操作，功能实现需要下列函数支持：
newList()：创建一个List；

splitStrToListString(String,String) ：将字符串按分隔符转换为List；

listSize(List) ：取List大小；

newMapPutAll(Map sourceMap) ：将源MAP全量赋值一个新MAP中；

listAddValue(List fromList,Map addMap)： 将MAP添加到List到末尾；

newMapInit(Object[])：新建Map，初始化字段值；

jsonStrToMap(String json)： JSON转Map；

getTextByTemplate(String msgTemplate,Map paramsValue)：按模板生成文本内容。

##### 6.1.5 操作步骤

a）创建实体模型

进入全自动开发平台“实体模型”功能模块，创建SyMessage（系统信息）实体模型，用于后续系统信息的赋值操作，如图6-6、图6-7所示：

![6-6](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/7.png)

##### 图6-6 选择实体模型

![6-7](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/8.png)

##### 图6-7 创建SyMessage实体模型

##### 注意：若对于如何新增实体模型不清晰，可参见[《SoFlu社区版基础操作指南第12章：实体模型》](https://gitee.com/feisuanyz/SoFlu-adp/tree/master/SoFlu%E7%A4%BE%E5%8C%BA%E7%89%88%E6%95%99%E7%A8%8B/SoFlu%E7%A4%BE%E5%8C%BA%E7%89%88%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C%E6%8C%87%E5%8D%97/12.%20%E5%AE%9E%E4%BD%93%E6%A8%A1%E5%9E%8B)

b）创建接口：新增站内信推送

b1）接口管理：新增接口（配置接口名称、路径等基本信息），如图6-8、图6-9所示：

![6-8](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/9.png)

##### 图6-8 选择接口管理

![6-9](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/10.png)

##### 图6-9 配置接口参数

b2）接口入参：配置请求参数、头部参数(按下列参数列表新增参数)，如图6-10、图6-11所示：

![6-10](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/11.png)

##### 图6-10 配置Body参数

![6-11](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/12.png)

##### 图6-11 配置头部参数

c）模型编辑

通过拖拽左侧组件列表中所需的组件进行模型编辑（即流程图编辑），如图6-12、图6-13所示：

![6-12](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/13.png)

##### 图6-12 进入模型编辑

![6-13](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/14.png)

##### 图6-13 编辑流程图

d）组件的具体配置

d1）使用单函数组件调用函数，处理请求参数

d1.1）调用newArrayList()函数创建一个List，创建一个ArrayList，如图6-14、图6-15所示：

![6-14](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/15.png)

##### 图6-14 创建一个List

![6-15](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/16.png)

##### 图6-15 填写数据

d1.2）调用splitStrToListString(String sourceStr,String splitStr)函数将请求参数receiveUser按分隔符“,”进行切割，并转换为List，如图6-16、图6-17所示：

##### 说明：这里需要做切割是因为可能有多个接收人。
