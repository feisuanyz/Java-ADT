### 6. 系统站内信推送

#### 6.1 系统站内信推送

系统推送站内信是系统开发中比较常用的功能，后端实现推送站内信的功能是将数据存储到数据库中（新增系统消息表），以方便前端页面调用数据，本节讲述如何使用全自动开发平台开发系统站内信后端功能。

##### 6.1.1 效果展示

![6-1](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/1.png)

##### 图6-1 APP消息模块推送消息界面

上图是APP消息模块推送手工消息的界面展示效果，对于后端开发来说，只需要将数据存储到<系统消息表>中即可，如图6-2所示：

![6-2](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/2.png)

##### 图6-2 系统消息表

##### 6.1.2 准备工作

需提前准备功能实现过程中用到的两张数据表：消息推送节点表 bs_message_node（用来存储消息模版消息）、系统消息表sy_message（用来存储推送消息），表结构设计及相关数据如下图所示：

消息推送节点表 bs_message_node：

```
CREATE TABLE `bs_message_node` (
  `send_node_id` varchar(50) NOT NULL COMMENT '推送节点编号',
  `send_node_name` varchar(100) DEFAULT NULL COMMENT '推送节点名称',
  `send_context` varchar(200) DEFAULT NULL COMMENT '推送内容',
  `message_title` varchar(200) DEFAULT NULL COMMENT '消息标题',
  `message_type` int(11) DEFAULT NULL COMMENT '消息类型',
  `goto_type` int(11) DEFAULT NULL COMMENT '跳转类别',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  PRIMARY KEY (`send_node_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='消息推送节点表';
```

![6-3](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/3.png)

##### 图6-3 消息推送节点表

消息推送节点表 bs_message_node：


```
CREATE TABLE `bs_message_node` (
  `send_node_id` varchar(50) NOT NULL COMMENT '推送节点编号',
  `send_node_name` varchar(100) DEFAULT NULL COMMENT '推送节点名称',
  `send_context` varchar(200) DEFAULT NULL COMMENT '推送内容',
  `message_title` varchar(200) DEFAULT NULL COMMENT '消息标题',
  `message_type` int(11) DEFAULT NULL COMMENT '消息类型',
  `goto_type` int(11) DEFAULT NULL COMMENT '跳转类别',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  PRIMARY KEY (`send_node_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='消息推送节点表';
```

系统消息表sy_message:

```
CREATE TABLE `sy_message` (
  `msg_id` varchar(24) COLLATE utf8_bin NOT NULL COMMENT '消息编号',
  `is_readed` int(11) DEFAULT NULL COMMENT '是否已查阅',
  `title` varchar(100) COLLATE utf8_bin DEFAULT NULL COMMENT '消息标题',
  `context` varchar(100) COLLATE utf8_bin DEFAULT NULL COMMENT '消息内容',
  `message_type` int(11) DEFAULT NULL COMMENT '消息类型',
  `goto_type` int(11) DEFAULT NULL COMMENT '跑转类别',
  `relation_id` varchar(24) COLLATE utf8_bin DEFAULT NULL COMMENT '关联编号',
  `receive_user` varchar(24) COLLATE utf8_bin DEFAULT NULL COMMENT '接收人',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `create_user` varchar(24) COLLATE utf8_bin DEFAULT NULL COMMENT '创建人',
 PRIMARY KEY (`msg_id`)
 )ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='系统消息表';
```

![6-4](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/4.png)

##### 图6-4 系统消息表

##### 6.1.3 流程图设计概述

![6-5](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/5.png)

##### 图6-5 流程图

逻辑概述：

a）系统消息分为系统自动发送的消息和管理员手工发送的消息，通过sendNodeId(推送节点编号)来判断推送消息方式，为空发送手工消息，不为空发送模版消息。

b）发送手工消息时，通过赋值组件对SyMessage实体模型字段进行赋值，然后调用新增SQL对表进行批量新增操作。

c）发送模版消息时，需要先根据sendNodeId(推送节点编号)查询<消息推送节点表 bs_message_node>中的message_title、message_type、send_context、goto_type字段信息。

d）使用按模板生成文本内容函数，将查询到的send_context内容中的‘{}’参数用入参params参数列表替换文本，然后赋值到SyMessage实体模型，根据不同接收人，将各个不同map放到一个初始化list中，最后执行批量新增SQL操作。

##### 6.1.4 技术要点概述

本实例涉及单函数、多函数、互斥条件、计数器、单SQL等组件，需要对参数进行处理后赋值给<系统消息表>的实体模型，最后执行新增操作，功能实现需要下列函数支持：
newList()：创建一个List；

splitStrToListString(String,String) ：将字符串按分隔符转换为List；

listSize(List) ：取List大小；

newMapPutAll(Map sourceMap) ：将源MAP全量赋值一个新MAP中；

listAddValue(List fromList,Map addMap)： 将MAP添加到List到末尾；

newMapInit(Object[])：新建Map，初始化字段值；

jsonStrToMap(String json)： JSON转Map；

getTextByTemplate(String msgTemplate,Map paramsValue)：按模板生成文本内容。

##### 6.1.5 操作步骤

a）创建实体模型

进入全自动开发平台“实体模型”功能模块，创建SyMessage（系统信息）实体模型，用于后续系统信息的赋值操作，如图6-6、图6-7所示：

![6-6](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/7.png)

##### 图6-6 选择实体模型

![6-7](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/8.png)

##### 图6-7 创建SyMessage实体模型

##### 注意：若对于如何新增实体模型不清晰，可参见[《SoFlu社区版基础操作指南第12章：实体模型》](https://gitee.com/feisuanyz/SoFlu-adp/tree/master/SoFlu%E7%A4%BE%E5%8C%BA%E7%89%88%E6%95%99%E7%A8%8B/SoFlu%E7%A4%BE%E5%8C%BA%E7%89%88%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C%E6%8C%87%E5%8D%97/12.%20%E5%AE%9E%E4%BD%93%E6%A8%A1%E5%9E%8B)

b）创建接口：新增站内信推送

b1）接口管理：新增接口（配置接口名称、路径等基本信息），如图6-8、图6-9所示：

![6-8](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/9.png)

##### 图6-8 选择接口管理

![6-9](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/10.png)

##### 图6-9 配置接口参数

b2）接口入参：配置请求参数、头部参数(按下列参数列表新增参数)，如图6-10、图6-11所示：

![6-10](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/11.png)

##### 图6-10 配置Body参数

![6-11](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/12.png)

##### 图6-11 配置头部参数

c）模型编辑

通过拖拽左侧组件列表中所需的组件进行模型编辑（即流程图编辑），如图6-12、图6-13所示：

![6-12](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/13.png)

##### 图6-12 进入模型编辑

![6-13](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/14.png)

##### 图6-13 编辑流程图

d）组件的具体配置

d1）使用单函数组件调用函数，处理请求参数

d1.1）调用newArrayList()函数创建一个List，创建一个ArrayList，如图6-14、图6-15所示：

![6-14](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/15.png)

##### 图6-14 创建一个List

![6-15](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/16.png)

##### 图6-15 填写数据

d1.2）调用splitStrToListString(String sourceStr,String splitStr)函数将请求参数receiveUser按分隔符“,”进行切割，并转换为List，如图6-16、图6-17所示：

##### 说明：这里需要做切割是因为可能有多个接收人。

![6-16](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/17.png)

##### 图6-16 进行切割及转换

![6-17](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/18.png)

##### 图6-17 填写数据

d1.3）调用listSize(List sourceList)函数获取接收人List大小，即接收人的个数，如图6-18、图6-19所示：

![6-18](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/19.png)

##### 图6-18 获取接收人List大小

![6-19](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/20.png)

##### 图6-19 填写数据

d2）使用互斥条件组件判断推送消息方式

![6-20](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/21.png)

##### 图6-20 判断逻辑

通过接口参数sendNodeId(推送节点编号)来判断推送消息方式，若sendNodeId为空，则推送手工消息；若sendNodeId不为空，则推送模版消息，如图6-21、图6-22所示：

![6-21](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/22.png)

##### 图6-21 手工消息流转条件

![6-22](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/23.png)

##### 图6-22 模板消息流转条件

d3）推送手工消息相关流程

![6-23](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/24.png)

##### 图6-23 流程图

d3.1）使用计数器组件对手工信息进行计数，需传入接收人List大小，操作符选择递增，如图6-24、图6-25所示：

![6-24](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/25.png)

##### 图6-24 使用计数器组件

![6-25](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/26.png)

##### 图6-25 计数器详情

d3.2）使用互斥条件组件判断是否继续推送手工消息循环，若手工消息计数器当前索引值小于接收人List大小，则继续推送手工消息循环；若手工消息计数器当前索引值大于等于接收人List大小，则退出推送手工消息循环，执行批量新增操作，如图6-26、图6-27、图6-28所示：

![6-26](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/27.png)

##### 图6-26 判断逻辑

![6-27](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/28.png)

##### 图6-27 继续推送手工消息循环的流转条件

![6-28](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/29.png)

##### 图6-28 退出推送手工消息循环的流转条件

d3.3）使用赋值条件组件为手工消息赋值，数据模型为开始时创建的SyMessage实体模型，如图6-29、图6-30、图6-31、图6-32、图6-33所示：

##### 注意：receiveUser的参数值引用的是${单函数组件编号[计数器组件编号]}，其中单函数组件为【切割并转换接收人receiveUser类型】，计数器组件为手工消息计数器。

![6-29](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/30.png)

##### 图6-29 使用赋值条件组件

![6-30](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/31.png)

##### 图6-30 数据模型为SyMessage

![6-31](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/32.png)

##### 图6-31 填写模型数据

![6-32](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/58.png)

##### 图6-32 切割与转换组件详情

![6-33](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/59.png)

##### 图6-33 手工消息计数器详情

d3.4）使用多函数组件调用函数newMapPutAll(Map)将源Map全量赋值一个新Map中，入参引用上一步赋值组件【赋值手工消息】SyMessage实体模型的值，设置结果标识“message”便于对该函数值的引用；同时调用函数listAddValue(List fromList,Map addMap)将记录1函数返回的Map添加到初始化List末尾处，入参选取初始化List以及记录1函数的结果标识“message”，如图6-34、图6-35、图6-36所示：

![6-34](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/33.png)

##### 图6-29 赋值Map并追加List

![6-35](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/34.png)

##### 图6-35 数据列表：newMapPutAll

![6-36](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/35.png)

##### 图6-36 数据列表：listAddValue

d4）推送模板消息相关流程

![6-37](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/36.png)

##### 图6-37 推送模板信息流程图

d4.1）使用单函数组件调用newMapInit(Object[] keyAndValue)构建查询参数sendNodeId，如图6-38、图6-39所示：

![6-38](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/37.png)

##### 图6-38 构建查询参数sendNodeId

![6-39](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/38.png)

##### 图6-39 填写数据

d4.2）使用单SQL组件查询《消息推送节点表》中对应推送节点编号sendNodeId的记录，具体SQL内容如下，如图6-40、图6-41所示：

![6-40](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/39.png)

##### 图6-40 查询《消息推送节点表》

![6-41](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/40.png)

##### 图6-41 填写数据

![6-42](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/60.png)

##### 图6-42 SQL内容

##### 注意：若对于如何新增SQL语句不清晰，可参见[《SoFlu社区版快速入门教程第4.6节：如何新增SQL信息》](https://gitee.com/feisuanyz/SoFlu-adp/blob/master/SoFlu%E7%A4%BE%E5%8C%BA%E7%89%88%E6%95%99%E7%A8%8B/SoFlu%E7%A4%BE%E5%8C%BA%E7%89%88%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/SoFlu%E7%A4%BE%E5%8C%BA%E7%89%88%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B.md#46-%E5%A6%82%E4%BD%95%E6%96%B0%E5%A2%9Esql%E4%BF%A1%E6%81%AF)

d4.3）使用多函数组件调用函数jsonStrToMap(String)将Json字符串转换为Map，需传入接口入参params（参数列表），并设置结果标识“params”便于函数值的引用；同时调用按模板生成文本内容函数getTextByTemplate(String,Map)进行模板信息替换，替换示例如下图所示，传入的参数为单SQL组件【查询《消息推送节点表》】查询记录中send_context的值以及记录1函数结果标识“params”，并勾选上作为输出结果：

![6-43](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/41.png)

##### 图6-43 替换规范消息模板

![6-44](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/42.png)

##### 图6-44 数据列表：jsonStrToMap

![6-45](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/43.png)

##### 图6-45 数据列表：getTextByTemplate

![6-46](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/72.jpg)

##### 图6-46 文本效果展示

d4.4）使用计数器组件作为推送模板计数器，循环流程变量为接收人List大小，操作符选择递增，如图6-47、图6-48所示：

![6-47](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/44.png)

##### 图6-47 使用计数器组件

![6-48](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/45.png)

##### 图6-48 计数器组件详情

d4.5）使用互斥条件组件判断是否继续推送模板消息循环，若推送模板计数器当前索引值小于接收人List大小，则继续推送模板消息循环；若推送模板计数器当前索引值大于等于接收人List大小，则退出推送模板消息循环，执行批量新增操作，如图6-49、图6-50、图6-51所示：

![6-49](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/46.png)

##### 图6-49 判断逻辑

![6-50](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/47.png)

##### 图6-50 继续推送模板消息循环的流转条件

![6-51](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/48.png)

##### 图6-51 退出推送模板消息循环的流转条件

d4.6）使用赋值条件组件将模板的内容赋值到SyMessage实体模型中，其中context参数值引用多函数组件【替换规范消息模板】的执行结果，即文本模板消息；relationId、createUser参数值引用接口参数的值；其它字段通过单SQL组件【查询《消息推送节点表》】查询出的对应字段值进行赋值。

##### 注意：receiveUser的参数值引用的是${单函数组件编号[计数器组件编号]}，与手工消息流程中的赋值组件类似，其中单函数组件为【切割并转换接收人receiveUser类型】，计数器组件为推送模板计数器。

![6-52](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/49.png)

##### 图6-52 赋值模板消息

![6-53](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/50.png)

##### 图6-53 赋值组件详情

![6-54](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/51.png)

##### 图6-54 填写模型数据

![6-55](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/62.png)

##### 图6-55 推送模板计数器

d4.7）与推送手工消息流程多函数组件【赋值Map追加List】配置类似，不同之处在于函数newMapPutAll(Map)的入参为赋值组件【赋值模板消息】SyMessage实体模型的值，如图6-56、图6-57、图6-58所示：

![6-56](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/52.png)

##### 图6-56 赋值Map并追加List

![6-57](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/53.png)

##### 图6-57 数据列表：newMapPutAll

![6-58](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/54.png)

##### 图6-58 数据列表：listAddValue

d5）批量新增《系统消息表》

退出推送手工消息/推送模板消息循环后，都需要进行批量新增《系统消息表》操作，以实现消息的推送，具体SQL内容如下，最后将新增操作的执行结果输出：

![6-59](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/63.png)

##### 图6-59 进行新增《系统消息表》操作

![6-60](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/56.png)

##### 图6-60 填写数据1

![6-61](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/57.png)

##### 图6-61 SQL内容

![6-62](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/64.png)

##### 图6-62 填写数据2

e）保存流程图

保存并退出模型编辑窗口。
