### 6. 系统站内信推送

#### 6.1 系统站内信推送

系统推送站内信是系统开发中比较常用的功能，后端实现推送站内信的功能是将数据存储到数据库中（新增系统消息表），以方便前端页面调用数据，本节讲述如何使用全自动开发平台开发系统站内信后端功能。

##### 6.1.1 效果展示

![6-1](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/1.png)

##### 图6-1 APP消息模块推送消息界面

上图是APP消息模块推送手工消息的界面展示效果，对于后端开发来说，只需要将数据存储到<系统消息表>中即可，如图6-2所示：

![6-2](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/2.png)

##### 图6-2 系统消息表

##### 6.1.2 准备工作

需提前准备功能实现过程中用到的两张数据表：消息推送节点表 bs_message_node（用来存储消息模版消息）、系统消息表sy_message（用来存储推送消息），表结构设计及相关数据如下图所示：

消息推送节点表 bs_message_node：

```
CREATE TABLE `bs_message_node` (
  `send_node_id` varchar(50) NOT NULL COMMENT '推送节点编号',
  `send_node_name` varchar(100) DEFAULT NULL COMMENT '推送节点名称',
  `send_context` varchar(200) DEFAULT NULL COMMENT '推送内容',
  `message_title` varchar(200) DEFAULT NULL COMMENT '消息标题',
  `message_type` int(11) DEFAULT NULL COMMENT '消息类型',
  `goto_type` int(11) DEFAULT NULL COMMENT '跳转类别',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  PRIMARY KEY (`send_node_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='消息推送节点表';
```

![6-3](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/3.png)

##### 图6-3 消息推送节点表

消息推送节点表 bs_message_node：


```
CREATE TABLE `bs_message_node` (
  `send_node_id` varchar(50) NOT NULL COMMENT '推送节点编号',
  `send_node_name` varchar(100) DEFAULT NULL COMMENT '推送节点名称',
  `send_context` varchar(200) DEFAULT NULL COMMENT '推送内容',
  `message_title` varchar(200) DEFAULT NULL COMMENT '消息标题',
  `message_type` int(11) DEFAULT NULL COMMENT '消息类型',
  `goto_type` int(11) DEFAULT NULL COMMENT '跳转类别',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  PRIMARY KEY (`send_node_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='消息推送节点表';
```

系统消息表sy_message:

```
CREATE TABLE `sy_message` (
  `msg_id` varchar(24) COLLATE utf8_bin NOT NULL COMMENT '消息编号',
  `is_readed` int(11) DEFAULT NULL COMMENT '是否已查阅',
  `title` varchar(100) COLLATE utf8_bin DEFAULT NULL COMMENT '消息标题',
  `context` varchar(100) COLLATE utf8_bin DEFAULT NULL COMMENT '消息内容',
  `message_type` int(11) DEFAULT NULL COMMENT '消息类型',
  `goto_type` int(11) DEFAULT NULL COMMENT '跑转类别',
  `relation_id` varchar(24) COLLATE utf8_bin DEFAULT NULL COMMENT '关联编号',
  `receive_user` varchar(24) COLLATE utf8_bin DEFAULT NULL COMMENT '接收人',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `create_user` varchar(24) COLLATE utf8_bin DEFAULT NULL COMMENT '创建人',
 PRIMARY KEY (`msg_id`)
 )ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='系统消息表';
```

![6-4](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/4.png)

##### 图6-4 系统消息表

##### 6.1.3 流程图设计概述

![6-5](https://www.feisuanyz.com/fsimage/alcj-image/systemmessage/5.png)

##### 图6-5 流程图

逻辑概述：

a）系统消息分为系统自动发送的消息和管理员手工发送的消息，通过sendNodeId(推送节点编号)来判断推送消息方式，为空发送手工消息，不为空发送模版消息。

b）发送手工消息时，通过赋值组件对SyMessage实体模型字段进行赋值，然后调用新增SQL对表进行批量新增操作。

c）发送模版消息时，需要先根据sendNodeId(推送节点编号)查询<消息推送节点表 bs_message_node>中的message_title、message_type、send_context、goto_type字段信息。

d）使用按模板生成文本内容函数，将查询到的send_context内容中的‘{}’参数用入参params参数列表替换文本，然后赋值到SyMessage实体模型，根据不同接收人，将各个不同map放到一个初始化list中，最后执行批量新增SQL操作。

##### 6.1.4 技术要点概述

本实例涉及单函数、多函数、互斥条件、计数器、单SQL等组件，需要对参数进行处理后赋值给<系统消息表>的实体模型，最后执行新增操作，功能实现需要下列函数支持：
newList()：创建一个List；

splitStrToListString(String,String) ：将字符串按分隔符转换为List；

listSize(List) ：取List大小；
