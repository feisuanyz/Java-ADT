### 2. 发送短信验证码

#### 2.1 发送短信验证码

本节实例是结合腾讯云实现发送短信验证码的功能，全自动开发平台不仅可以在平台内部实现功能开发，还可以与外部工具联用以实现用户各种各样的功能需求，体现了全自动开发平台灵活包容、便捷好用的功能特点。实例主要用到了平台的单函数组件、单SQL组件、互斥条件组件，这三种组件的结合也是一种经典搭配，可适用于多种不同的案例场景，同时通过调用平台中的系统函数或自定义函数来实现特定功能。

##### 2.1.1 效果展示

通过调用发送短信验证码接口，传入接收短信验证码的手机号，即可实现对指定手机号发送短信验证码的功能，如图2-1所示：

![2-1](https://feisuanyz.com/fsimage/alcj-image/sendmessage/send_1.png)

##### 图2-1 编辑接口测试用例

![2-2](https://feisuanyz.com/fsimage/alcj-image/sendmessage/send_2.png)

##### 图2-2 验证码信息

##### 2.1.2 准备工作

a）提前准备一个开通了短信服务的腾讯云账号，关于如何注册腾讯云账号及开通短信服务可参见腾讯云文档(文档中心 > 短信 > 国内短信 > 国内短信快速入门)。

b）提前准备功能实现过程中需要使用到的两张数据表：参数表sy_params（用来配置获取验证码次数上限和验证码有效时长的参数信息）、短信表user_note（用来存储用户手机号、发送短信次数、发送短信时间及短信验证码等信息），表结构设计及相关数据如下图所示：

参数表sy_params：

```
CREATE TABLE `sy_params` (
  `param_id` varchar(24) NOT NULL COMMENT '参数编号',
  `param_remark` varchar(100) DEFAULT '' COMMENT '参数说明',
  `param_value` varchar(50) DEFAULT '' COMMENT '参数值',
  `data_type` varchar(6) DEFAULT '' COMMENT '数据类型',
  `create_user` varchar(24) DEFAULT '' COMMENT '创建人',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
 `update_time` datetime DEFAULT NULL COMMENT '更新时间',
  `update_user` varchar(24) DEFAULT NULL COMMENT '更新人',
  PRIMARY KEY (`param_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='参数表';

```

![2-3](https://feisuanyz.com/fsimage/alcj-image/sendmessage/send_3.png)

##### 图2-3 参数表参数说明

##### 说明：参数表中的配置信息可自行设置，本案例主要配置了verificationCodeDuration 【验证码有效时长（分钟）】和todayVerification【当天获取验证码次数上限】。

短信表user_note：

```
CREATE TABLE `user_note` (
  `mobileSms_id` varchar(255) NOT NULL COMMENT '短信记录Id',
  `receiver_mobile` varchar(255) DEFAULT '' COMMENT '手机号',
  `dayNum` int(11) DEFAULT NULL COMMENT '当天获取验证码次数',
  `create_time` datetime DEFAULT NULL COMMENT '验证码发送时间',
  `verify_code` varchar(255) DEFAULT '' COMMENT '发送的验证码'
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='短信表';
```

![2-4](https://feisuanyz.com/fsimage/alcj-image/sendmessage/send_4.png)

##### 图2-4 短信表参数说明

##### 说明：短信表中的数据在调用接口后自动生成。

c）需进入腾讯云短信控制台拿到相关短信参数，放入全自动开发平台配置组管理中，具体如下图所示：

![2-5](https://feisuanyz.com/fsimage/alcj-image/sendmessage/send_5.png)

##### 图2-5 相关短信参数

##### 说明：此处的参数字段分别为secretId（腾讯云密钥secretId）、secretKey（腾讯云密钥secretId）、smsSdkAppId（腾讯云密钥AppId）、sign（签名）、templateID（短信模板Id），其参数值均可以在腾讯云短信控制台拿到。因本案例需与腾讯云结合使用，具体的参数值均需要用户自行创建密钥、签名及短信正文模板后获取，创建方式可参见文档https://cloud.tencent.com/document/product/382/37745（文档中心 > 短信 > 国内短信 > 国内短信快速入门）。

![2-6](https://feisuanyz.com/fsimage/alcj-image/sendmessage/send_6.png)

##### 图2-6 API密钥管理

![2-7](https://feisuanyz.com/fsimage/alcj-image/sendmessage/send_7.png)

##### 图2-7 签名管理

![2-8](https://feisuanyz.com/fsimage/alcj-image/sendmessage/send_8.png)

##### 图2-8 正文模板管理

##### 注意：若对于如何新增配置组不清晰，可参见[《SoFlu社区版基础操作指南第13.1节：新增配置组》](https://gitee.com/feisuanyz/SoFlu-adp/blob/master/SoFlu%E7%A4%BE%E5%8C%BA%E7%89%88%E6%95%99%E7%A8%8B/SoFlu%E7%A4%BE%E5%8C%BA%E7%89%88%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C%E6%8C%87%E5%8D%97/13.%20%E9%85%8D%E7%BD%AE%E7%BB%84%E7%AE%A1%E7%90%86/1.%20%E6%96%B0%E5%A2%9E%E9%85%8D%E7%BD%AE%E7%BB%84.md)

##### 2.1.3 流程图设计概览

![2-9](https://feisuanyz.com/fsimage/alcj-image/sendmessage/send_9.png)

##### 图2-9 流程图上半部分


![2-10](https://feisuanyz.com/fsimage/alcj-image/sendmessage/send_10.png)

##### 图2-10 流程图下半部分

逻辑描述：

a）在【参数表】查询【当天获取验证码次数上限】。

b）在【短信表】查询当前手机号当天获取验证码的次数。

c）判断当前手机号【当天获取验证码次数】的值是否为空，若为空，则进行新增操作，新增一条发送短信记录；若不为空，继续以下流程。

d）再次查询【短信表】，获取【当前手机号当天获取验证码的次数】

e）判断【当前手机号当天获取验证码的次数】是否小于【当天获取验证码次数上限】，若大于等于，说明今日已超过验证码发送次数限制，将输出发送失败信息；若小于，则继续以下流程。

f）生成短信验证码。

g）为当前手机号加上中国大陆地区手机标识【+86】（因为本案例仅针对国内手机号验证码发送）。

h）给指定手机号发送验证码信息。

i）更新当前手机号短信表中的内容，即当前手机号验证码发送次数、验证码发送时间、当前发送的验证码信息。

j）输出验证码发送成功信息。

##### 2.1.4 操作步骤

a）新增发送短信验证码接口

进入全自动开发平台“接口管理”功能模块，新增接口模块并新增一个接口，填写接口的基本信息。

![2-11](https://feisuanyz.com/fsimage/alcj-image/sendmessage/send_11.png)

##### 图2-11 点击接口管理

![2-12](https://feisuanyz.com/fsimage/alcj-image/sendmessage/send_12.png)

##### 图2-12 填写基本信息

b）配置接口的入口参数

此处需配置一个String类型的参数receiverMobile作为接收验证码的手机号。

![2-13](https://feisuanyz.com/fsimage/alcj-image/sendmessage/send_13.png)

##### 图2-13 配置入口参数

c）模型编辑

通过拖拽左侧组件列表中所需的组件进行模型编辑（即流程图编辑）。

![2-14](https://feisuanyz.com/fsimage/alcj-image/sendmessage/send_14.png)

##### 图2-14 点击模型编辑

![2-15](https://feisuanyz.com/fsimage/alcj-image/sendmessage/send_15.png)

##### 图2-15 编辑流程图

d）组件的具体配置（按逻辑描述展示）

d1）在【参数表】查询【当天获取验证码次数上限】。

d1-1）使用单函数组件调用函数newMapInit(Object[] keyAndValue)构造查询参数【paramId】，需传入参数值todayVerification，在参数表中表示【当天获取验证码次数上限】。

![2-16](https://feisuanyz.com/fsimage/alcj-image/sendmessage/send_16.png)

##### 图2-16 构造查询参数

![2-17](https://feisuanyz.com/fsimage/alcj-image/sendmessage/send_17.png)

##### 图2-17 填写数据

d1-2）使用单SQL组件在【参数表】查询【当天获取验证码次数上限】，具体SQL内容如下，需传入上一步构建的查询参数【paramId】。

![2-18](https://feisuanyz.com/fsimage/alcj-image/sendmessage/send_18.png)

##### 图2-18 在【参数表】查询【当天获取验证码次数上限】

![2-19](https://feisuanyz.com/fsimage/alcj-image/sendmessage/send_19.png)

##### 图2-19 填写数据

![2-20](https://feisuanyz.com/fsimage/alcj-image/sendmessage/send_20.png)

##### 图2-20 SQL内容

##### 注意：若对于如何新增SQL语句不清晰，可参见[《SoFlu社区版快速入门教程第4.6节：如何新增SQL信息》](https://gitee.com/feisuanyz/SoFlu-adp/blob/master/SoFlu%E7%A4%BE%E5%8C%BA%E7%89%88%E6%95%99%E7%A8%8B/SoFlu%E7%A4%BE%E5%8C%BA%E7%89%88%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/SoFlu%E7%A4%BE%E5%8C%BA%E7%89%88%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B.md#46-%E5%A6%82%E4%BD%95%E6%96%B0%E5%A2%9Esql%E4%BF%A1%E6%81%AF)

d2）在【短信表】查询当前手机号当天获取验证码的次数。

d2-1）使用单函数组件调用函数getCurrDate()获取当前日期。

![2-21](https://www.feisuanyz.com/fsimage/alcj-image/sendmessage/send_21.png)

##### 图2-21 获取当前日期

![2-22](https://www.feisuanyz.com/fsimage/alcj-image/sendmessage/send_22.png)

##### 图2-22 填写数据

d2-2）使用单函数组件调用函数newMapInit(Object[] keyAndValue)构造查询参数【手机号】【当前日期】，需传入参数receiverMobile（接收验证码的手机号）以及上一步获取到的createTime（当前日期）。

![2-23](https://www.feisuanyz.com/fsimage/alcj-image/sendmessage/send_23.png)

##### 图2-23 构造查询参数

![2-24](https://www.feisuanyz.com/fsimage/alcj-image/sendmessage/send_24.png)

##### 图2-24 填写数据

d2-3）使用单SQL组件根据手机号及当前日期在【短信表】查询【当天获取验证码次数】，具体的SQL内容如下，需传入上一步构建的查询参数【手机号】及【当前日期】。

![2-25](https://www.feisuanyz.com/fsimage/alcj-image/sendmessage/send_25.png)

##### 图2-25 查询【当天获取验证码次数】

![2-26](https://www.feisuanyz.com/fsimage/alcj-image/sendmessage/send_26.png)

##### 图2-26 填写数据

![2-27](https://www.feisuanyz.com/fsimage/alcj-image/sendmessage/send_27.png)

##### 图2-27 SQL内容


d3）判断当前手机号【当天获取验证码次数】的值是否为空，若为空，则进行新增操作，新增一条发送短信记录；若不为空，继续以下流程。

d3-1）使用单函数组件调用函数getCurrDateTime()获取当前系统时间，用于后续新增发送短信记录。

![2-28](https://www.feisuanyz.com/fsimage/alcj-image/sendmessage/send_28.png)

##### 图2-28 获取当前系统时间

![2-29](https://www.feisuanyz.com/fsimage/alcj-image/sendmessage/send_29.png)

##### 图2-29 填写数据

d3-2）使用互斥条件组件来判断【当天获取验证码次数】的值是否为空，若为空，则使用单函数组件调用newMapInit(Object[] keyAndValue)构造新增参数mobileSmsId（短信记录Id，根据函数getUuid()获取）、receiverMobile（接收验证码的手机号）、createTime（当前系统时间）。

![2-30](https://www.feisuanyz.com/fsimage/alcj-image/sendmessage/send_30.png)

##### 图2-30 判断流程

![2-31](https://www.feisuanyz.com/fsimage/alcj-image/sendmessage/send_31.png)

##### 图2-31 流转条件

![2-32](https://www.feisuanyz.com/fsimage/alcj-image/sendmessage/send_32.png)

##### 图2-32 填写数据（记录1-记录3）

![2-33](https://www.feisuanyz.com/fsimage/alcj-image/sendmessage/send_33.png)

##### 图2-33 填写数据（记录4-记录6）

d3-3）使用单SQL组件在【短信表】新增发送短信记录，具体SQL内容如下，需传入上一步构建的新增参数。

![2-34](https://www.feisuanyz.com/fsimage/alcj-image/sendmessage/send_34.png)

##### 图2-34 新增发送短信记录

![2-35](https://www.feisuanyz.com/fsimage/alcj-image/sendmessage/send_35.png)

##### 图2-35 填写数据

![2-36](https://www.feisuanyz.com/fsimage/alcj-image/sendmessage/send_36.png)

##### 图2-36 SQL内容

d3-4）若不为空，则使用单函数组件调用函数strToInt(String sourceValue)将参数表中【param_value】转为整型，即将参数表中【当天获取验证码次数上限】的参数类型由字符型转为整型，便于后续修改短信表中增加获取验证码次数的操作。

![2-37](https://www.feisuanyz.com/fsimage/alcj-image/sendmessage/send_37.png)

##### 图2-37 不为空时的操作

![2-38](https://www.feisuanyz.com/fsimage/alcj-image/sendmessage/send_38.png)

##### 图2-38 流转条件

![2-39](https://www.feisuanyz.com/fsimage/alcj-image/sendmessage/send_39.png)

##### 图2-39 填写数据

d4）再次使用单SQL组件，根据当前手机号及当前时间查询【短信表】获取【当前手机号当天获取验证码的次数】，具体SQL信息如下。（此处再次查询短信表是由于新增操作后短信表有更新）

![2-40](https://www.feisuanyz.com/fsimage/alcj-image/sendmessage/send_40.png)

##### 图2-40 再次查询短信表

![2-41](https://www.feisuanyz.com/fsimage/alcj-image/sendmessage/send_41.png)
