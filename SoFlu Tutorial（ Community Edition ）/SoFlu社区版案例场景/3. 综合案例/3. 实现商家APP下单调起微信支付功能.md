### 3. 实现商家APP下单调起微信支付功能

#### 3.1 实现商家APP下单调起微信支付功能

微信支付是我们日常生活中一种常见的支付方式，拥有自主APP的商家为了满足顾客的多重支付方式需求，通常会考虑接入微信支付功能。本节实例将以展示利用全自动开发平台实现商家APP下单调起微信支付功能作为示例来介绍全自动开发平台的使用，实例主要用到了全自动开发平台中的单函数组件、HTTP组件、互斥条件组件。通过拖拽方式绘制流程图并进行参数配置等同于编写复杂代码的业务逻辑，业务逻辑可视化展示，相对于写代码，用户可以更加轻松地进行功能实现。

##### 3.1.1 效果展示

执行设计好的调起微信支付功能接口，接口将返回前端调起微信支付页面所需的相关参数，如图3-1所示：

![3-1](https://www.feisuanyz.com/fsimage/alcj-image/wechatpay/wcpay_2-1.png)

##### 图3-1 响应内容页面

##### 注意：本实例仅针对后端程序开发，若与前端程序联合使用，可展示更加明显的效果，即可看到微信支付页面。

##### 3.1.2 准备工作

a）若您想要实际完成APP下单调起微信支付的功能，您需要提前注册微信支付商户号，如图3-1所示。注册好商户号后，进行下载并配置商户证书的操作，获取证书序列号及相应的证书存放路径，如图3-2所示。这三个参数（商户号、证书序列号、证书存放路径）将在接下来的开发过程中用到。

注册地址：https://pay.weixin.qq.com/index.php/apply/applyment_home/guide_normal

下载并配置商户证书指引地址：https://pay.weixin.qq.com/wiki/doc/apiv3/open/pay/chapter2_5_1.shtml

![3-2](https://www.feisuanyz.com/fsimage/alcj-image/wechatpay/wcpay_3-1.png)

##### 图3-2 注册微信支付商户号

![3-3](https://www.feisuanyz.com/fsimage/alcj-image/wechatpay/wcpay_3-2.png)

##### 图3-3 下载并配置商户证书

b）本实例功能的实现包含两个过程：APP下单和APP调起支付。您可以分别于微信支付APP下单和APP调起支付的API文档，查看相应请求参数的具体说明，如图3-4、3-5所示：

APP下单API文档地址：https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_2_1.shtml

APP调起支付API文档地址：https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_2_4.shtml

![3-4](https://www.feisuanyz.com/fsimage/alcj-image/wechatpay/wcpay_3-3.png)

##### 图3-4 APP下单API文档页面

![3-5](https://www.feisuanyz.com/fsimage/alcj-image/wechatpay/wcpay_3-4.png)

##### 图3-5 APP调起支付API文档页面

c）上一步所需请求参数中的应用ID，即appid，需通过微信开发平台（open.weixin.qq.com）审核后获取，如图3-6所示：

![3-6](https://www.feisuanyz.com/fsimage/alcj-image/wechatpay/wcpay_3-5.png)

##### 图3-6 AppID获取流程

##### 3.1.3 流程图设计概览

![3-7](https://www.feisuanyz.com/fsimage/alcj-image/wechatpay/wcpay_4-1.png)

##### 图3-7 接口流程图（上）

![3-8](https://www.feisuanyz.com/fsimage/alcj-image/wechatpay/wcpay_4-2.png)

##### 图3-8 接口流程图（下）

逻辑描述：

a）为APP下单请求参数赋值。

b）将实体模型AppPay的参数值（即APP下单请求参数）的数据类型转换为Json字符串，便于后续作为请求报文主体。

c）获取wechat支付token，用于拼接APP下单请求头信息。

d）拼接APP下单请求头。

e）进行APP下单操作。

f）根据状态码值判断APP下单是否成功，若APP下单失败，则输出APP下单失败信息；若APP下单成功，则继续以下流程。

g）获取当前时间戳，用于后续生成微信支付签名及作为APP下单调起微信支付的参数之一。

h）获取32位随机编码，用于后续生成微信支付签名及作为APP下单调起微信支付的参数之一。

i）生成微信APP支付签名，作为APP下单调起微信支付的参数之一。

j）拼接APP下单调起微信支付的相关参数。

k）将拼接好的参数输出。

##### 3.1.4 操作步骤

a）创建实体模型：AppPay

进入全自动开发平台“实体模型”功能模块，新增“AppPay”（APP下单请求参数）的实体模型，用于后续APP下单请求参数的赋值（参考微信支付APP下单API文档中请求参数进行创建）。

![3-9](https://www.feisuanyz.com/fsimage/alcj-image/wechatpay/wcpay_6-1.png)

##### 图3-9 实体模型功能模块

![3-10](https://www.feisuanyz.com/fsimage/alcj-image/wechatpay/wcpay_6-2.png)

##### 图3-10 创建AppPay实体模型

b）创建接口：APP下单调起微信支付

进入全自动开发平台“接口管理”功能模块，新增一个接口，填写接口的基本信息，单击“下一步”。

![3-11](https://www.feisuanyz.com/fsimage/alcj-image/wechatpay/wcpay_6-3.png)
