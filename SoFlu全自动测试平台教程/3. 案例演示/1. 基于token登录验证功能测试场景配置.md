### 3. 案例演示

#### 3.1 基于token登录验证功能测试场景配置

当用户直接通过URL访问特定页面时，一般会遇到这样的情况，若未登录当前网站，则会被重新导航至登录页面，若已登录过当前网站，才可以通过URL直接访问特定页面。

内部实现逻辑可参考如下：

a）客户端输入用户名和密码向服务器端发起验证；

b）服务器端验证通过之后根据某种规则生成用户的token并返回，token保存在redis中，以保证不同服务器间的共享；

c）客户端存储该token，可以存储在sessionStorage或者cookie中；

d）后续服务器的每次请求都在请求头携带token发送到服务端；

e）服务端在执行方法前先对请求进行验证，取出token查询redis中有没有对应的值。

本节将使用全自动测试平台测试登录验证功能中的两个接口，通过配置合适的测试场景，来检测登录验证功能是否可以正常实现。

##### 3.1.1 测试场景配置说明

##### a）关联接口：

a1）接口A：登录验证接口，用于提取用户的token信息，存储到cookie管理器中。

a2）接口B：查询接口，即登录验证成功之后的特定页面，若接口A提取到了正确的token信息，则接口B可以请求成功。

##### b）测试目的：

b1）测试是否通过请求接口A获取到了token值。

b2）测试接口B是否可以请求成功，以检测token值是否正确。

##### c）场景配置大致流程：

c1）创建变量集：用于创建请求头参数userID。

c2）创建场景组：用于将后续所有场景配置归属到同一场景组。

c3）创建cookie管理器：用于存储提取的token信息。

c4）创建信息头管理器：用于为当前场景组所有请求接口添加固定的头部参数userID。

c5）为当前场景组关联接口A。

c6）创建正则提取器：通过设置正确的正则表达式来提取接口A响应头中的token值。

c7）为当前场景组关联接口B。

c8）设置响应断言：通过判断接口B响应体信息中是否包含id、name字段信息，来判断接口B是否请求成功。

c9）保存场景配置，执行测试场景，查看执行报告。

##### 3.1.2 前置条件

a）所在测试项目已做好环境配置，否则无法添加测试接口并执行测试场景，具体操作可参见《SoFlu全自动测试平台教程操作指南第2.1.9节：新增环境配置》；

b）测试用例模块中已创建对应接口测试用例，否则无法选择测试用例进行场景配置，具体操作可参见《SoFlu全自动测试平台教程操作指南第2.3.1.1节：新增测试用例》；

c）接口管理模块中已添加需测试的接口，否则进行场景配置时无法关联对应的接口，具体操作可参见《SoFlu全自动测试平台教程操作指南第2.4.2.4节：新增接口》。

##### 3.1.3 场景配置具体操作

a）创建变量集

目的：用于创建请求头参数userID。

a1）单击“接口测试 > 变量集 > 新增变量集”。

a2）填写变量集名称，单击“新增变量”创建请求头参数userID。

![image](https://user-images.githubusercontent.com/79617492/191472304-84db5b38-9e12-4097-99d0-bc61a01670d1.png)

##### 图1-1 填写变量集信息

##### 说明：变量集、SQL管理以及Excel管理一般用于创建场景配置需引用的数据信息。

b）创建场景组

目的：用于将后续所有场景配置归属到同一场景组。

b1）单击“接口测试 > 测试场景管理”。

b2）选择已创建的接口测试用例，在根场景组下创建场景组。

![image](https://user-images.githubusercontent.com/79617492/191472337-26b109a8-74ad-4ae5-8aab-c8ca74971904.png)

##### 图1-2 创建场景组

##### 说明：根场景组下可创建多个场景组，不同场景组间线程分离，可同时运行多个场景组。

c）创建cookie管理器

目的：用于存储提取的token信息。

c1）选中场景组，单击“+ > 配置器”。

![image](https://user-images.githubusercontent.com/79617492/191472377-d7c21b71-7b70-4f54-96aa-6fef87fa4c6f.png)

##### 图1-3 单击“+ > 配置器”

c2）选择“cookie管理器”，填写cookie管理器注释信息即可。

![image](https://user-images.githubusercontent.com/79617492/191472409-73d3e554-34bf-418c-9245-19cd375079f1.png)

##### 图1-4 填写cookie管理器注释信息

##### 说明：此处仅需创建cookie管理器便可以存储通过接口A获取的token信息，并用于同一场景组下的接口B，无需再新增cookie。

d）创建信息头管理器

目的：用于为当前场景组所有请求接口添加固定的头部参数userID

d1）选中场景组，单击“+ > 配置器”。

d2）选择“信息头管理器”，填写信息头管理器的注释信息。

d3）单击“新增header”添加信息头，选择步骤a）创建的变量集即可。

![image](https://user-images.githubusercontent.com/79617492/191472456-1e993c17-de04-4727-a1dd-2411ea186c1a.png)

##### 图1-5 单击“新增header”添加信息头

e）为当前场景组关联接口A

e1）选中场景组，单击“+ > 接口”。

![image](https://user-images.githubusercontent.com/79617492/191472487-20699f9c-7224-408c-90f1-3b3cc5328b72.png)

##### 图1-6 单击“+ > 接口”

e2）勾选对应接口模块下的接口后，单击“确定”即可。

![image](https://user-images.githubusercontent.com/79617492/191472526-1724d7db-db55-4986-aa6a-5fc70931cfdf.png)

##### 图1-7 单击“确定”

f）创建正则提取器

目的：通过设置正确的正则表达式来提取接口A响应头中的token值。

f1）选中接口A，单击“+ > 后置处理器”。

![image](https://user-images.githubusercontent.com/79617492/191472563-1dca8d55-50e4-4bd0-80dd-6955a5f32291.png)

##### 图1-8 单击“+ > 后置处理器”

f2）选择“正则提取器”，填写正则提取器的基本信息和默认值。

![image](https://user-images.githubusercontent.com/79617492/191472592-b21a19ff-51ae-4a9d-8b07-2ee5dcb659ae.png)

##### 图1-9 填写正则提取器的基本信息和默认值

```
填写说明：

匹配数量：设置为0，表示提取符合条件的随机一个；

正则表达式：由于请求接口A返回的响应头信息中“Set-Cookie: connect.sid=”后的参数值表示token值，故此处正则表达式设置为Set-Cookie: connect.sid=(.+?)，表示提取括号部分第一个匹配项；

模板：设置为 $1$，表示解析到的第一个值；

要检查的响应字段：选择“信息头”，表示对请求接口的响应信息头进行信息提取；

默认值：表示若通过设置的正则表达式未提取到结果，则赋值默认值。

```

g）为当前场景组关联接口B（与步骤 a）类似）

h）设置响应断言

目的：通过判断接口B响应体信息中是否包含id、name字段信息，来判断接口B是否请求成功。

h1）选中接口B，单击“+ > 断言”。

![image](https://user-images.githubusercontent.com/79617492/191472615-be0fb4d8-d2fa-4876-ba91-c498da26d984.png)

##### 图1-10 单击“+ > 断言”

h2）选择“响应断言”，填写注释信息，选择测试字段“响应体”和匹配规则“包括”。

h3）新增两个常量值id、name，表示判断接口B响应体内容是否包括id、name字段信息。

![image](https://user-images.githubusercontent.com/79617492/191472647-c04fa3c3-ecd2-4d86-9109-35248828f225.png)

##### 图1-11 新增两个常量值

i）保存场景配置，执行测试场景

i1）进行每一步场景配置后，都需单击“保存”保存当前场景配置，以防数据丢失。

i2）测试场景配置完成后，单击“执行”执行当前测试场景。

j）查看执行报告

j1）通过测试场景整体执行报告，可以得知当前测试场景执行成功。

![image](https://user-images.githubusercontent.com/79617492/191472685-00fc1c86-fab7-42f6-90a8-3e8714f67d26.png)

##### 图1-12 当前测试场景执行成功

j2）查看接口A执行详情，通过响应头及提取内容可以看到正常从接口A响应头中提取到了token信息。

![image](https://user-images.githubusercontent.com/79617492/191472710-f03696e3-508b-4cee-9457-31340d9798b5.png)

##### 图1-13 响应头

![image](https://user-images.githubusercontent.com/79617492/191472743-3e459e8d-5920-4329-8401-66689780e9c1.png)

##### 图1-14 提取内容

j3）查看接口B执行详情，通过响应体和断言信息可以得知请求接口B成功，同时可查看到接口B的请求内容带上了接口A提取的Token值，说明基于token登录验证功能可以正常实现。

![image](https://user-images.githubusercontent.com/79617492/191472773-38e3ab09-b57f-44ca-81db-2975ecfd63aa.png)

##### 图1-15 响应体

![image](https://user-images.githubusercontent.com/79617492/191472800-84546564-c6c8-4370-b123-147a54bd378e.png)

##### 图1-16 断言信息

![image](https://user-images.githubusercontent.com/79617492/191472821-f89f429f-3c58-481f-becb-16f050200292.png)

##### 图1-17 请求内容

##### 登录验证功能内部实现逻辑说明参考原文链接： https://blog.csdn.net/qq_20786911/article/details/104687728 
