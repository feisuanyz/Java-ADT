### 5. 案例场景

#### 5.2 常见案例

#### 5.2.2 电商平台应用

#### 5.2.2.4 订单超时自动删除

日常生活中，我们经常需要使用到电商平台，例如淘宝、京东、拼多多等。在这些交易场景下的订单一般会设置一个支付时间，若超过这个支付时间，该订单将自动取消并删除（或订单状态变为已过期）。

在本节案例中，我们将使用全自动开发平台实现订单超时自动删除功能。相比于传统开发，利用全自动开发平台可视化开发功能，将功能的实现逻辑在流程图中展示，开发过程变得更加简洁。

#### 5.2.2.4.1 效果展示

在全自动开发平台中，执行“订单超时自动删除”定时任务，系统将弹出调用成功的详情页面。若data输出“0”，则说明没有需要删除的订单；若data输出1，则说明删除了1条超时订单；以此类推data输出3即说明删除了3条超时订单，如图4-1所示。此时数据库中的订单表有如下变化：未支付且超过规定支付时间的订单将会自动删除，如图4-2、4-3所示。

##### 说明：本案例仅针对后端程序开发，若与前端页面联调可实现如图4-4、4-5所展示的效果，此处以淘宝平台为例。

![输入图片说明](../../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/2.%20%E5%B8%B8%E8%A7%81%E6%A1%88%E4%BE%8B/2.%20%E7%94%B5%E5%95%86%E5%B9%B3%E5%8F%B0%E5%BA%94%E7%94%A8/4-1.png)

##### 图4-1 定时任务调用详情页面    

![输入图片说明](../../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/2.%20%E5%B8%B8%E8%A7%81%E6%A1%88%E4%BE%8B/2.%20%E7%94%B5%E5%95%86%E5%B9%B3%E5%8F%B0%E5%BA%94%E7%94%A8/4-2.png)

##### 图4-2 调用定时任务前订单表数据

![输入图片说明](../../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/2.%20%E5%B8%B8%E8%A7%81%E6%A1%88%E4%BE%8B/2.%20%E7%94%B5%E5%95%86%E5%B9%B3%E5%8F%B0%E5%BA%94%E7%94%A8/4-3.png)

##### 图4-3 调用定时任务后订单表数据

![输入图片说明](../../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/2.%20%E5%B8%B8%E8%A7%81%E6%A1%88%E4%BE%8B/2.%20%E7%94%B5%E5%95%86%E5%B9%B3%E5%8F%B0%E5%BA%94%E7%94%A8/4-4.png)

##### 图4-4 执行前前端页面效果

![输入图片说明](../../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/2.%20%E5%B8%B8%E8%A7%81%E6%A1%88%E4%BE%8B/2.%20%E7%94%B5%E5%95%86%E5%B9%B3%E5%8F%B0%E5%BA%94%E7%94%A8/4-5.png)

##### 图4-5 执行后前端页面效果

#### 5.2.2.4.2 准备工作

提前准备一张数据表：订单表 order_info（用于存储订单信息），表结构设计及相关数据如下图所示。

订单表 order_info：

```
CREATE TABLE `order_info` (
  `order_id` varchar(24) NOT NULL DEFAULT '' COMMENT '订单号',
  `customer_id` varchar(9) DEFAULT NULL COMMENT '客户编号',
  `pay_money` decimal(12,2) DEFAULT NULL COMMENT '支付金额',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',   
  `pay_status` int(11) DEFAULT NULL COMMENT '支付状态',   
  PRIMARY KEY (`order_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='订单表';
```

##### 说明：订单表中的数据可以自行配置，其中pay_status（支付状态）为1时表示订单已支付，为0时表示订单未支付。

![输入图片说明](../../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/2.%20%E5%B8%B8%E8%A7%81%E6%A1%88%E4%BE%8B/2.%20%E7%94%B5%E5%95%86%E5%B9%B3%E5%8F%B0%E5%BA%94%E7%94%A8/4-6.png)

##### 图4-6 订单表数据

#### 5.2.2.4.3 流程图设计概览

![输入图片说明](../../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/2.%20%E5%B8%B8%E8%A7%81%E6%A1%88%E4%BE%8B/2.%20%E7%94%B5%E5%95%86%E5%B9%B3%E5%8F%B0%E5%BA%94%E7%94%A8/4-7.png)

##### 图4-7 定时任务流程图

逻辑描述：

a）将“需删除的未支付且超过支付时间的订单数目”初始化设置为0；

b）在<订单表>查询未支付订单信息；

c）获取<订单表>中未支付订单的总数；

d）遍历查询到的未支付订单信息，若当前计数器索引值小于未支付订单总数，则开始遍历流程；若当前计数器索引值大于等于未支付订单总数，则进行遍历完成流程；

e）开始遍历流程：

e1）获取当前计数器索引值指向未支付订单的最后支付时间（即订单创建时间加上30分钟）；

e2）获取当前系统时间；

e3）判断当前未支付订单是否支付超时，若支付超时，即当前未支付订单的最后支付时间小于等于当前系统时间，则进行支付超时流程；若支付未超时，即当前未支付订单的最后支付时间大于当前系统时间，继续遍历下一条数据；

e4）支付超时流程：删除当前未支付订单；

e5）支付超时流程：需删除的未支付且超过支付时间的订单数目加1，继续遍历下一条数据；

f）遍历完成流程：输出需删除的未支付且超过支付时间的订单数目，结束流程。

#### 5.2.2.4.4 全自动开发平台具体操作过程

a）新增实体模型count

a1）进入全自动开发平台“实体模型”功能模块，新增一个实体模型Count，用于记录“需删除的未支付且超过支付时间的订单数目”，如下图所示。

![输入图片说明](../../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/2.%20%E5%B8%B8%E8%A7%81%E6%A1%88%E4%BE%8B/2.%20%E7%94%B5%E5%95%86%E5%B9%B3%E5%8F%B0%E5%BA%94%E7%94%A8/4-8.png)

##### 图4-8 实体模型模块

![输入图片说明](../../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/2.%20%E5%B8%B8%E8%A7%81%E6%A1%88%E4%BE%8B/2.%20%E7%94%B5%E5%95%86%E5%B9%B3%E5%8F%B0%E5%BA%94%E7%94%A8/4-9.png)

##### 图4-9 新增实体模型

b）新增定时任务：订单超时自动删除

b1）进入全自动开发平台“定时任务”功能模块，新增一个定时任务，填写定时任务的基本信息，并设置Cron表达式，如下图所示。

说明：
本案例设置该定时任务5分钟执行一次，所以Cron表达式中秒指定为0即可，如图4-9所示，分钟设置为“从0开始，每5分钟执行一次”，您可以预览最近10次的执行时间，如图4-10所示，您也可以根据实际需求设置Cron表达式。

![输入图片说明](../../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/2.%20%E5%B8%B8%E8%A7%81%E6%A1%88%E4%BE%8B/2.%20%E7%94%B5%E5%95%86%E5%B9%B3%E5%8F%B0%E5%BA%94%E7%94%A8/4-10.png)

##### 图4-10 定时任务模块

![输入图片说明](../../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/2.%20%E5%B8%B8%E8%A7%81%E6%A1%88%E4%BE%8B/2.%20%E7%94%B5%E5%95%86%E5%B9%B3%E5%8F%B0%E5%BA%94%E7%94%A8/4-11.png)

##### 图4-11 新增定时任务
