### 5. 案例场景

#### 5.4 综合案例

#### 5.4.2 发送短信验证码

本节实例是结合腾讯云实现发送短信验证码的功能，全自动开发平台不仅可以在平台内部实现功能开发，还可以与外部工具联用以实现用户各种各样的功能需求，体现了全自动开发平台灵活包容、便捷好用的功能特点。实例主要用到了平台的单函数组件、单SQL组件、互斥条件组件，这三种组件的结合也是一种经典搭配，可适用于多种不同的案例场景，同时通过调用平台中的系统函数或自定义函数来实现特定功能。

#### 5.4.2.1 效果展示

通过调用发送短信验证码接口，传入接收短信验证码的手机号，即可实现对指定手机号发送短信验证码的功能，如下图所示。

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/4.%20%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B/2-1.png)

##### 图2-1 传入接收短信验证码的手机号

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/4.%20%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B/2-2.png)

##### 图2-2 效果展示

#### 5.4.2.2 准备工作

a）提前准备一个开通了短信服务的腾讯云账号，关于如何注册腾讯云账号及开通短信服务可参见[腾讯云文档](https://cloud.tencent.com/document/product/382/37745)(文档中心 > 短信 > 国内短信 > 国内短信快速入门)。

b）提前准备功能实现过程中需要使用到的两张数据表：参数表sy_params（用来配置获取验证码次数上限和验证码有效时长的参数信息）、短信表user_note（用来存储用户手机号、发送短信次数、发送短信时间及短信验证码等信息），表结构设计及相关数据如下图所示。

参数表sy_params：

```
CREATE TABLE `sy_params` (
  `param_id` varchar(24) NOT NULL COMMENT '参数编号',
  `param_remark` varchar(100) DEFAULT '' COMMENT '参数说明',
  `param_value` varchar(50) DEFAULT '' COMMENT '参数值',
  `data_type` varchar(6) DEFAULT '' COMMENT '数据类型',
  `create_user` varchar(24) DEFAULT '' COMMENT '创建人',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
 `update_time` datetime DEFAULT NULL COMMENT '更新时间',
  `update_user` varchar(24) DEFAULT NULL COMMENT '更新人',
  PRIMARY KEY (`param_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='参数表';
```

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/4.%20%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B/2-3.png)

##### 图2-3 表结构设计及相关数据

##### 说明：参数表中的配置信息可自行设置，本案例主要配置了verificationCodeDuration 【验证码有效时长（分钟）】和todayVerification【当天获取验证码次数上限】。

短信表user_note：

```
CREATE TABLE `user_note` (
  `mobileSms_id` varchar(255) NOT NULL COMMENT '短信记录Id',
  `receiver_mobile` varchar(255) DEFAULT '' COMMENT '手机号',
  `dayNum` int(11) DEFAULT NULL COMMENT '当天获取验证码次数',
  `create_time` datetime DEFAULT NULL COMMENT '验证码发送时间',
  `verify_code` varchar(255) DEFAULT '' COMMENT '发送的验证码'
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='短信表';
```

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/4.%20%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B/2-4.png)

##### 图2-4 表结构设计及相关数据

##### 说明：短信表中的数据在调用接口后自动生成。

c）需进入腾讯云短信控制台拿到相关短信参数，放入全自动开发平台配置组管理中，具体如下图所示。

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/4.%20%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B/2-5.png)

##### 图2-5 配置相关短信参数

##### 说明：此处的参数字段分别为secretId（腾讯云密钥secretId）、secretKey（腾讯云密钥secretId）、smsSdkAppId（腾讯云密钥AppId）、sign（签名）、templateID（短信模板Id），其参数值均可以在腾讯云短信控制台拿到。因本案例需与腾讯云结合使用，具体的参数值均需要用户自行创建密钥、签名及短信正文模板后获取，创建方式可参见[腾讯相关文档](https://cloud.tencent.com/document/product/382/37745)（文档中心 > 短信 > 国内短信 > 国内短信快速入门）。

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/4.%20%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B/2-6.png)

##### 图2-6 获取腾讯云密钥

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/4.%20%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B/2-7.png)

##### 图2-7 获取签名参数值

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/4.%20%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B/2-8.png)

##### 图2-8 获取短信模板id参数值

##### 注意：若对于如何新增配置组不清晰，可参见《SoFlu（后端）全自动开发平台教程第4.17.1节：新增配置组》。

#### 5.4.2.3 流程图设计概览

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/4.%20%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B/2-9.png)

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/4.%20%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B/2-10.png)

##### 图2-9/10 流程图设计概览

逻辑描述：

a）在【参数表】查询【当天获取验证码次数上限】。

b）在【短信表】查询当前手机号当天获取验证码的次数。

c）判断当前手机号【当天获取验证码次数】的值是否为空，若为空，则进行新增操作，新增一条发送短信记录；若不为空，继续以下流程。

d）再次查询【短信表】，获取【当前手机号当天获取验证码的次数】

e）判断【当前手机号当天获取验证码的次数】是否小于【当天获取验证码次数上限】，若大于等于，说明今日已超过验证码发送次数限制，将输出发送失败信息；若小于，则继续以下流程。

f）生成短信验证码。

g）为当前手机号加上中国大陆地区手机标识【+86】。（因为本案例仅针对国内手机号验证码发送）

h）给指定手机号发送验证码信息。

i）更新当前手机号短信表中的内容，即当前手机号验证码发送次数、验证码发送时间、当前发送的验证码信息。

j）输出验证码发送成功信息。

#### 5.4.2.4 全自动开发平台具体操作过程

#### 5.4.2.4.1 新增发送短信验证码接口

a）进入全自动开发平台“接口管理”功能模块，新增接口模块并新增一个接口，填写接口的基本信息。

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/4.%20%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B/2-11.png)

##### 图2-11 点击“接口管理”

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/4.%20%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B/2-12.png)

##### 图2-12 填写接口的基本信息

#### 5.4.2.4.2 配置接口的入口参数

a）此处需配置一个String类型的参数receiverMobile作为接收验证码的手机号。

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/4.%20%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B/2-13.png)

##### 图2-13 配置一个String类型的参数receiverMobile

#### 5.4.2.4.3 模型编辑

a）通过拖拽左侧组件列表中所需的组件进行模型编辑（即流程图编辑）。

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/4.%20%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B/2-14.png)

##### 图2-14 进入模型编辑

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/4.%20%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B/2-15.png)

##### 图2-15 进行模型编辑

#### 5.4.2.4.4 组件的具体配置（按逻辑描述展示）

a）在【参数表】查询【当天获取验证码次数上限】。

a1）使用单函数组件调用函数newMapInit(Object[] keyAndValue)构造查询参数【paramId】，需传入参数值todayVerification，在参数表中表示【当天获取验证码次数上限】。

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/4.%20%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B/2-16.png)

##### 图2-16 构造查询参数【paramId】

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/4.%20%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B/2-17.png)

##### 图2-17 填写数据

a2）使用单SQL组件在【参数表】查询【当天获取验证码次数上限】，具体SQL内容如下，需传入上一步构建的查询参数【paramId】。

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/5.%20%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF/4.%20%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B/2-18.png)

##### 图2-18 查询【当天获取验证码次数上限】
