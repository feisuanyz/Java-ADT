### 6. 组件使用

#### 6.3 数据库组件

#### 6.3.1 Elasticsearch组件

Elasticsearch是一个分布式、高扩展、高实时的搜索与数据分析引擎，用户可以在平台通过Elasticsearch组件实现分布式全文搜索。

Es实现原理：首先用户将数据提交到Elasticsearch数据库中，通过分词控制器将对应的语句分词，将其权重和分词结果一并存入数据；当用户搜索数据时，再根据权重给结果排名、打分，最后将返回结果呈现给用户。

#### 6.3.1.1 前提条件

a）项目中已加载Elasticsearch组件

b）项目中已创建Elasticsearch资源实例，具体操作可参见《SoFlu（后端）全自动开发平台教程第4.15.1.12节：新增Elasticsearch资源》。

#### 6.3.1.2 步骤引导

a）使用es组件新增数据

b）使用es组件批量新增数据

c）使用es组件更新数据

d）使用es组件删除数据

e）使用es组件查询一条数据

f）使用es组件分页查询数据

g）使用es组件实现聚合查询

h）使用es组件实现分页聚合查询

#### 6.3.1.2.1 使用es组件新增数据

a）在配置接口参数处，添加需要新增数据的字段信息。

![image](https://user-images.githubusercontent.com/79617492/208059267-26cfcfb4-723c-48e1-942a-58a0f1250a97.png)

##### 图1-1 添加需要新增数据的字段信息

b）进入窗体视图，在左侧组件列表找到Elasticsearch组件，拖拽至中间模型编辑区。

##### 说明：若您需与其他组件搭配使用，则选择所需组件连接好组件流程图后，再进行以下Elasticsearch组件的配置即可。

![image](https://user-images.githubusercontent.com/79617492/208059284-706b225e-30a7-4af9-b343-4b99fbee15af.png)

##### 图1-2 拖拽Elasticsearch组件

c）选中Elasticsearch组件，单击选择记录方框选择Elasticsearch资源实例。

![image](https://user-images.githubusercontent.com/79617492/208059458-36d0c882-0241-4f2f-bbf7-b1ef7441e616.png)

##### 图1-3 选择Elasticsearch资源实例

d）根据实际需求填入索引名，功能方法选择“新增数据”。

##### 说明：此处索引名相当于数据库中的表名，当Elasticsearch数据库中存在该索引名时，则会直接执行功能方法；当数据库中不存在该索引名时，会先在数据库自动新增该索引名，再执行功能方法。

![image](https://user-images.githubusercontent.com/79617492/208059578-d825135f-8b73-4d98-b9cd-0fb600153eeb.png)

##### 图1-4 功能方法选择“新增数据”

e）单击未选中记录方框配置参数信息，配置完成后单击确定即可。

##### 说明：当前选择入口参数为例，其它入参同理，参数字段名等于索引字段名，参数字段值等于索引字段值，若参数字段名在索引名中不存在，则会自动新增该字段名。

![image](https://user-images.githubusercontent.com/79617492/208059604-5594e5e5-9850-44bb-b432-23e324769284.png)

##### 图1-5 配置参数信息

#### 6.3.1.2.2 使用es组件批量新增数据

a）根据实际需求填入索引名，功能方法选择“批量新增数据”。

##### 说明：批量新增数据，即把参数里的集合的数据批量插入到索引名中。当存在该索引名时，则会直接执行功能方法，当不存在该索引名时，会先在服务中自动新增该索引名，再执行功能方法。

![image](https://user-images.githubusercontent.com/79617492/208059625-eac0a7a3-ec31-40fb-9c8c-64228abfa08f.png)

##### 图1-6 功能方法选择“批量新增数据”

b）单击未选中记录方框配置参数信息，配置完成后单击确定即可。

```
说明：

b1）当前选择入口参数为例，其它参数同理，参数字段名等于索引字段名，参数字段值等于索引字段值，如果参数字段名在索引名中不存在，则会自动新增该字段名。

b2）批量新增数据方法的入参数据类型必须为集合类型。
```

![image](https://user-images.githubusercontent.com/79617492/208059660-a073044f-b3d8-44f0-b587-f310205958d3.png)

##### 图1-7 配置参数信息

#### 6.3.1.2.3 使用es组件更新数据

a）根据需求填入索引名，功能方法选择“更新数据”。

##### 说明：更新数据功能方法相当于数据库语句的update，用于修改指定数据。

![image](https://user-images.githubusercontent.com/79617492/208059678-ef69f986-05df-406b-bb46-bd69a972ecb8.png)

##### 图1-8 功能方法选择“更新数据”

b）单击未选中记录方框配置参数信息，进入填写数据页面，单击“更新内容”后的 + 按钮 填写需要更新的字段内容。

```
说明：

b1）字段名称：填写需要更新的字段名称。

b2）字段值：填写需要更新的字段值。

b3）如有多个字段，点击“+”添加。
```

![image](https://user-images.githubusercontent.com/79617492/208059697-eb555acd-140e-4220-b15a-7734953b73cd.png)

##### 图1-9 填写需要更新的字段内容

c）单击“条件”后的 +按钮 填写筛选条件，所有信息填写完成后，单击确定即可。

```
说明：

c1）es数据库会根据条件中的字段信息、查询方式、联合查询方式查询出对应的数据，然后更新内容。

c2）联合查询方式说明：

must：查询结果包含条件分词，按照条件分词匹配度排序，匹配度越高排在前面。

should: 查询结果包含条件分词，当存在多条查询条件时，只要满足任意一个条件即返回结果，按照默认排序。

filter：查询结果包含条件分词，按照默认排序。

mustNot：与must用法相反，查询出的结果不包含条件分词，按照默认排序。

c3）查询方式说明：

模糊查询：只要目标分词中有一个与查询条件的分词匹配即可，与普通的模糊查询有所区别，Elasticsearch是根据分词进行模糊查询，分词是由分词控制器将一句话自动分成若干个词语。示例：飞算科技，会划分为飞算、科技两个分词，模糊查询“飞算”能查询出飞算科技，但仅模糊查询“飞”则无法查询出飞算科技。

精确查询：只有目标分词全部与查询条件的分词相同时，才能匹配到。
```

![image](https://user-images.githubusercontent.com/79617492/208059727-7726f171-72d0-4947-8afb-9ca129cbeadd.png)

##### 图1-10 填写筛选条件

#### 6.3.1.2.4 使用es组件删除数据

a）根据需求填入索引名，功能方法选择“删除数据”。

##### 说明：删除数据功能方法相当于数据库语句的delete，用于删除指定数据。

![image](https://user-images.githubusercontent.com/79617492/208060028-883931ba-d08b-4f9d-b964-76eb37bea75a.png)

##### 图1-11 功能方法选择“删除数据”

b）单击未选中记录方框配置参数信息，进入填写数据页面，单击“条件”后的 +按钮 填写需要删除的字段内容。

![image](https://user-images.githubusercontent.com/79617492/208060055-dac98099-f39b-4de8-859f-32a500e70708.png)

##### 图1-12 填写需要删除的字段内容

c）填写完成后，单击确定即可，执行接口时会根据查询结果删除对应的数据。

#### 6.3.1.2.5 使用es组件查询一条数据

a）根据需求填入索引名，功能方法选择“查询一条数据”。

##### 说明：查询一条数据功能方法相当于数据库语句的select，用于查询指定数据，但只会返回列表第一条数据。

![image](https://user-images.githubusercontent.com/79617492/208060081-05d873e9-fe7f-4e67-9c24-23c5eb05858b.png)

##### 图1-13 功能方法选择“查询一条数据”

b）单击未选中记录方框配置参数信息，进入填写数据页面，单击“条件”后的 +按钮 填写需要查询的字段内容。

![image](https://user-images.githubusercontent.com/79617492/208060099-a2385fa9-73d8-4c07-a41c-0bb6b61135b6.png)

##### 图1-14 填写需要查询的字段内容

c）填写完成后，单击确定即可。

#### 6.3.1.2.6 使用es组件分页查询数据

a）根据需求填入索引名，功能方法选择“分页查询数据”。

##### 说明：分页查询功能方法主要是对查询的数据进行分页处理。

![image](https://user-images.githubusercontent.com/79617492/208060116-7f509b56-d8ef-47dc-9cdd-b2f7c12563d8.png)

##### 图1-15 功能方法选择“分页查询数据”

b）单击未选中记录方框配置参数信息，进入填写数据页面，单击“条件”后的 + 按钮填写需要查询的字段内容。

![image](https://user-images.githubusercontent.com/79617492/208060137-1412d82b-fa77-495a-8c6d-1fda1ff82492.png)

##### 图1-16 填写需要查询的字段内容

c）填写当前页数下标和每页大小，单击确定即可。

```
说明：

c1）执行接口时将根据填写的页面下标和每页大小，把查询结果进行分页展示。

c2）排序：根据指定字段进行升序或降序，不使用则为默认排序。
```

![image](https://user-images.githubusercontent.com/79617492/208060156-5593b92b-ad7d-4d35-a778-756604a407df.png)

##### 图1-17 填写当前页数下标和每页大小

#### 6.3.1.2.7 使用es组件实现聚合查询

a）根据需求填入索引名，功能方法选择“聚合查询”。

##### 说明：聚合查询功能方法，主要用于对查询的数据使用聚合函数。

![image](https://user-images.githubusercontent.com/79617492/208060172-628ab081-dd9f-4936-9e3f-c8f19c14e264.png)

##### 图1-18 功能方法选择“聚合查询”

b）单击未选中记录方框配置参数信息，进入填写数据页面，单击“字段列表”后的 + 按钮填写需要使用聚合函数的字段名称、字段别名和聚合方式。

![image](https://user-images.githubusercontent.com/79617492/208060187-bb80a5f3-c91f-48af-bc2e-7ce5aded5154.png)

##### 图1-19 填写聚合函数的相关信息

c）单击“条件”后的 + 按钮填写筛选条件，所有信息填写完成后，单击确定即可。

##### 说明：执行接口时会根据条件查询出来的数据，通过聚合方式进行计算，然后显示结果。

![image](https://user-images.githubusercontent.com/79617492/208060210-18f6e468-358e-46d0-bc74-8558f8e59d3f.png)

##### 图1-20 填写筛选条件

#### 6.3.1.2.8 使用es组件实现分页聚合查询

a）根据需求填入索引名，功能方法选择“分页聚合查询”。

##### 说明：分页聚合查询功能方法，主要是对聚合查询出来的数据进行分页处理。

![image](https://user-images.githubusercontent.com/79617492/208060232-4bfda2dd-b98c-4b2d-833d-5781d682f1bd.png)

##### 图1-21 功能方法选择“分页聚合查询”

b）单击未选中记录方框配置参数信息，进入填写数据页面，单击“字段列表”后的 + 按钮填写需要使用聚合函数的字段名称、字段别名和聚合方式。

![image](https://user-images.githubusercontent.com/79617492/208060244-ac133a00-cdd6-4078-80f4-a1f33f7ef371.png)

##### 图1-22 填写聚合函数的相关信息

c）单击“条件”后的 + 按钮填写筛选条件，然后填写当前页数下标、每页大小，最后单击确定即可。

##### 说明：执行接口时会将聚合查询出来的数据，根据下标和每页大小进行分页展示。

![image](https://user-images.githubusercontent.com/79617492/208060261-1f920ce9-d58c-41a4-9ff9-076cbdb923df.png)

##### 图1-23 填写筛选条件、当前页数下标、每页大小等
