### 7. 进阶指南

#### 7.1 微服务治理

#### 7.1.2 集成Consul注册中心

Consul是HashiCorp公司推出的开源工具，用于实现分布式系统的服务发现与配置。Consul的形式为“一站式”，内置了服务注册与发现框架、分布一致性协议实现、监控检测、Key/Value存储，以及多数据中心方案等，不再需要依赖其他工具，使用起来也比较简单。本节为您介绍如何在（后端）全自动开发平台使用Consul注册中心的服务。

##### 说明：（后端）全自动开发平台中的项目需通过使用本地客户端或部署项目的方式进行配置，才可在Consule注册中心注册并使用Consule注册中心的服务，未进行配置注册的项目不可以使用Consul注册中心的服务。使用本地客户端和部署项目的详细操作请参见《SoFlu（后端）全自动开发平台教程第2.1节：注册账户》和《SoFlu（后端）全自动开发平台教程第2.9.1节：如何部署项目》。

#### 7.1.2.1 步骤引导

a）配置注册Consul

b）使用Consul服务

#### 7.1.2.1.1 配置注册Consul

a）访问Consul官网下载Consul的最新版本，解压后启动Consul。

b）启动成功后浏览器访问： http://localhost:8500 ，即可看到Consul的管理界面。

c）在使用本地客户端或部署项目时打开bootstrap.yml配置文件，在文件中增加如下配置：

```
consul:  
    enabled: true # 是否开启consul服务注册
    service:
        interval: 2   # 心跳频率（秒）  
    nodes:    
        url: http://127.0.0.1:8500 # consul服务节点，多个服务使用逗号分隔
```



```
说明：

c1）若无bootstrap.yml文件，请手动创建。

c2）注册中心注册优先级为：Nacos >> Consul >> Eureka >> Etcd，使用Consul服务时请确保Nacos注册中心开关为false，如下图所示。
```

![image](https://user-images.githubusercontent.com/79617492/210530561-c432517d-1ee2-4464-b1ef-912d608bd7ea.png)

##### 图2-1 确保Nacos注册中心开关为false

d）若通过本地客户端进行配置，双击startup.bat启动服务同时确保需注册项目在平台中属于启动状态，对应项目即可在Consul注册中心注册成功；若通过部署项目的方式进行配置，则只需要双击startup.bat启动服务即可。

e）进入Consul管理界面，查看对应项目的名称是否存在，若存在即表示注册成功，其中绿色勾表示生效，红色叉表示失效，如下图所示。

![image](https://user-images.githubusercontent.com/79617492/210530596-83d8b884-23b1-4b28-8164-edd6e6564854.png)

##### 图2-2 绿色勾表示生效

##### 配置注册好Consul之后，便可在已注册项目中使用Consul服务。

#### 7.1.2.1.2 使用Consul服务

a）为已注册项目添加Consul配置资源和FeignClient组件：进入（后端）全自动开发平台，单击项目卡片上的设置按钮![image](https://user-images.githubusercontent.com/79617492/210530846-cc416b40-da91-47af-860e-45299fb78464.png)进入项目加载项页面。

##### 说明：其中FeignCient组件用于微服务调用，详情请参见《SoFlu（后端）全自动开发平台教程第6.9.1节：使用FeignCient组件进行微服务调用》。

![image](https://user-images.githubusercontent.com/79617492/210530956-ed7a44f0-2b97-4f0d-a04c-e02ab1a6886e.png)

##### 图2-3 添加Consul配置资源

![image](https://user-images.githubusercontent.com/79617492/210530984-5e19fddf-3ce5-42fe-ae08-585069710267.png)

##### 图2-4 添加FeignClient组件

b）进入项目资源实例功能模块，新增Consul配置资源实例。

![image](https://user-images.githubusercontent.com/79617492/210531006-5e72215b-236a-43b0-b061-f2d7265dd2b2.png)

##### 图2-5 新增Consul配置资源实例

c）创建接口，进行接口流程图编辑。

##### 说明：此处需使用FeignClient组件才可调用Consul微服务，同时简单搭配输出结果组件作为示例。

![image](https://user-images.githubusercontent.com/79617492/210531040-b874c8c9-c0c8-47bd-9ff8-f17fb9877202.png)

##### 图2-6 进行接口流程图编辑

d）选中FeignClient组件，注册中心类型选择consul注册中心，注册中心资源选择新增的Consul配置资源实例。

e）自定义配置http请求参数。

![image](https://user-images.githubusercontent.com/79617492/210531065-5ba92ba8-8335-4653-ba92-368e0b65762e.png)

##### 图2-7 自定义配置http请求参数

f）配置好输出结果组件，单击“保存并退出”。

g）执行测试用例，看到接口能正常访问即可。

![image](https://user-images.githubusercontent.com/79617492/210531073-5333f6f5-4cdd-42db-96ab-a450157c7c74.png)

##### 图2-8 执行测试用例
