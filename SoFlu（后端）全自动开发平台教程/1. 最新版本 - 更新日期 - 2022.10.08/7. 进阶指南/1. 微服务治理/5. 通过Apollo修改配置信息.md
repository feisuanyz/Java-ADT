### 7. 进阶指南

#### 7.1 微服务治理

#### 7.1.5 通过Apollo修改配置信息

##### Apollo（阿波罗）是携程开源的分布式配置中心，能够集中化管理应用不同环境、不同集群的配置，支持修改配置后实时推送到应用端，并具备规范的权限及流程治理等特性。

全自动开发平台支持对接Apollo配置中心，用户在Apollo配置中修改资源实例或配置组等相关配置信息后，配置信息将实时生效或者重启服务后生效，无需再重新部署项目。本节将为您介绍如何通过Apollo修改配置信息，该功能目前只支持执行引擎离线模式。

#### 7.1.5.1 步骤一：Apollo服务配置

更详细的apollo使用说明请参考：https://github.com/apolloconfig/apollo/wiki/Apollo开放平台

a）搭建Apollo服务，建议参考官网搭建教程后，自行搭建。

b）登录Apollo配置中心，浏览器打开apollo-portal地址即可。

![image](https://user-images.githubusercontent.com/79617492/210973861-e92002c1-c089-4a89-a82e-0c05a85bf1ec.png)

##### 图5-1 登录Apollo配置中心

c）单击“创建项目”，进入创建项目页面。

![image](https://user-images.githubusercontent.com/79617492/210973903-5ef0d8d4-9be8-4135-ace8-2e6bedc934fc.png)

##### 图5-2 单击“创建项目”

d）根据需求填写字段信息后，单击“提交”，创建项目成功。

![image](https://user-images.githubusercontent.com/79617492/210973965-584693c7-6d86-46b8-8d2b-24f6e2aa6a47.png)

##### 图5-3 单击“提交”

e）单击右上角菜单“管理员工具 > 开放平台授权管理”，进入创建第三方应用页面。

![image](https://user-images.githubusercontent.com/79617492/210973988-37b529c2-15d9-43ec-9076-16659c392d2e.png)

##### 图5-4 单击“开放平台授权管理”

f）填写第三方应用创建信息，单击“创建”。

##### 说明：第三方负责人要向apollo管理员提供第三方应用的基本信息，创建前要先点击查询，查看这个第三方应用ID是否被创建，创建成功后会生成一个token值。

![image](https://user-images.githubusercontent.com/79617492/210974007-9499cc5c-0e58-4c1a-9737-b1d6a44ad02d.png)

##### 图5-5 填写第三方应用创建信息

g）创建成功，获取到token。

##### 说明：第三方应用不能操作任何Namespace的配置，所以要给token绑定可以操作的Namespace,在步骤8进行赋权，赋权之后，第三方应用就可以通过apollo来管理已授权的Namespace配置。

![image](https://user-images.githubusercontent.com/79617492/210974025-1a9cae34-a297-45ab-976b-6ff6876bf4e6.png)

##### 图5-6 获取到token

h）填写赋权字段下的所有信息。

```
字段说明：

h1）被管理的Appid：步骤4所填写的应用id

h2）被管理的Namespace：针对需要单独控制的配置文件，填写配置文件名称，未填写则默认所有

h3）授权类型：Namespace只能修改和发布配置文件信息，APP能够创建、修改和发布配置文件信息
```

![image](https://user-images.githubusercontent.com/79617492/210974239-1ebbf1f2-e56a-4d5c-8702-c826d1129d72.png)

##### 图5-7 填写赋权字段下的所有信息

i）单击“提交”，第三方应用赋权成功。

![image](https://user-images.githubusercontent.com/79617492/210974272-07d79872-9a31-44c3-9c13-cdd7833e8680.png)

##### 图5-8 单击“提交”

#### 7.1.5.2 步骤二：在Apollo配置中心修改配置信息

a）在启动项目的配置文件bootstrap.yml中增加以下配置，若无此文件，新增即可。

```
apollo:  
    enabled: true   # 是否开启Apollo  
    meta: http://172.16.147.185:8080  # apollo-config-service地址  
    portalUrl: http://172.16.147.187:8080   # apollo-portal地址  
    token: 87c03d769e678faba33af97fbcdf580853726031   # Apollo的项目授权的token  
    user: apollo    # Apollo的用户名  
    env: DEV    # Apollo环境   
    cluster: default    # 集群名称，在apollo中可新建集群，填写对应名称即可
app:  
    id: ceshi  # Apollo项目名
```

![image](https://user-images.githubusercontent.com/79617492/210974300-c3a1c686-1af6-4cf6-8e94-bea62314bbf3.png)

##### 图5-9 增加的配置内容

##### meta地址查看方式：单击apollo系统右上角的“管理员工具 > 系统信息”， bootstrap.yml配置文件中env选择什么环境就填写对应meta server其中之一即可。

![image](https://user-images.githubusercontent.com/79617492/210974326-8ba4648d-8c9a-4eff-a7fa-ccd7d2ff89cd.png)

##### 图5-10 单击“系统信息”

b）启动项目。

![image](https://user-images.githubusercontent.com/79617492/210974363-e9421e9b-7bbd-420a-a247-0b77e2bded55.png)

##### 图5-11 启动项目

c）单击apollo配置中心的testdemo项目。

![image](https://user-images.githubusercontent.com/79617492/210974383-cf57ba6e-f210-470b-b238-a15945aa9118.png)

##### 图5-12 单击testdemo项目

d）选择DEV环境，显示所有资源实例或和配置组信息写入成功。

```
注意：

d1）Namespsce命名空间在apollo配置中心中唯一，当A项目已存在该命名空间的配置文件时，B项目无法写入相同命名空间的配置文件。

d2）如果项目的资源实例或配置组信息采用中文命名，则在apollo配置中心上会转译成相应的中文拼音。
```

![image](https://user-images.githubusercontent.com/79617492/210974421-dfcb5a54-9935-4fbf-95e3-d18e22e307b7.png)

##### 图5-13 写入成功

e）展开对应的配置文件，可查看到对应的key和value值，单击修改按钮。

##### 说明：如果配置文件中存在key对应的value值为空时，在apollo配置中心将不显示此key。

![image](https://user-images.githubusercontent.com/79617492/210974444-ba61e0fc-fb72-4b9a-9ded-5a3dcda22c49.png)

##### 图5-14 单击修改按钮

f）根据需求，修改配置信息，单击“提交”。

![image](https://user-images.githubusercontent.com/79617492/210974464-29e53cde-316e-4154-ac65-73ba3e6ded1b.png)

##### 图5-15 修改配置信息

g）最后单击“发布”即可。

##### 说明：发布后配置文件实时生效还是重启服务后生效，具体要根据项目开发时写入配置文件的生效方式决定，并非所有配置文件都是实时生效。

![image](https://user-images.githubusercontent.com/79617492/210974482-beeba0e3-9048-4ff1-8cf6-e7b3bcfc9035.png)

##### 图5-16 单击发布
