### 7. 进阶指南

#### 7.7 事务

#### 7.7.1 分布式事务Seata

分布式事务是指在分布式环境下由不同的服务之间通过网络远程协作完成事务，而Seata是一款开源的分布式事务解决方案。平台支持分布式事务Seata，在调用不同服务的接口可以一起提交事务和回滚，保持数据的准确性，有助于提供高性能和简单易用的分布式事务服务。

#### 7.7.1.1 步骤概述

a）配置分布式事务Seata

b）添加分布式事务Seata资源实例

c）数据库里创建undo_log表

d）开启分布式事务

#### 7.7.1.2 操作步骤

#### 7.7.1.2.1 配置分布式事务Seata

a）以配置nacos举例，打开nacos服务地址，在配置中心中新建配置，填写配置信息，单击发布。

```
说明：

a1）nacos服务需要用户自行搭建，新建配置的内容可参考https://github.com/seata/seata/tree/develop/script/config-center的config.text配置文件。

a2）从Seatea 1.4.2版本开始，已支持从一个Nacos dataId中获取所有配置信息。
```

![image](https://user-images.githubusercontent.com/79617492/211256658-819735ab-62cd-42ea-8c35-9a7202da5071.png)

##### 图1-1 在配置中心中新建配置

b）在 https://seata.io/zh-cn/blog/download.html 里下载seata文件。

![image](https://user-images.githubusercontent.com/79617492/211256679-e6ea9579-06ec-4d3f-a791-6419aedd354f.png)

##### 图1-2 下载seata文件

c）解压文件夹，然后在conf文件夹下找到 “registry.conf”文件。

![image](https://user-images.githubusercontent.com/79617492/211256695-84c5f13e-e54f-47db-8f3f-e38156ab8e48.png)

##### 图1-3 找到 “registry.conf”文件

d）打开 “registry.conf”文件，根据需求修改对应配置相关字段的信息。

##### 说明：关于更多详细配置可参考官方文档“ https://seata.io/zh-cn/docs/overview/what-is-seata.html ”，这里以配置nacos举例，则nacos的相关字段信息要和对应的注册中心或配置中心上的保持一致。

![image](https://user-images.githubusercontent.com/79617492/211256761-bc044eda-2406-49e2-9dd8-ce47a0ea9c4d.png)

![image](https://user-images.githubusercontent.com/79617492/211256770-d0c77390-f024-4ec7-96e5-34188b0c09a0.png)

##### 图1-4/5 修改对应配置相关字段的信息

e）在bin文件夹下双击 “seata-server.bat”。

![image](https://user-images.githubusercontent.com/79617492/211256805-b04eddac-31bf-49e1-a380-50bd56b5e959.png)

##### 图1-6 双击 “seata-server.bat”

f）启动成功。

![image](https://user-images.githubusercontent.com/79617492/211256815-840443c8-703a-4bb7-ba0a-d6cb87299a98.png)

##### 图1-7 启动成功

#### 7.7.1.2.2 添加分布式事务Seata资源实例

a）在项目加载项页面，单击资源 > 添加分布式事务Seata资源实例，然后单击加载应用。

![image](https://user-images.githubusercontent.com/79617492/211256833-662d95e5-a264-49b9-a55d-8642b129c268.png)

##### 图1-8 加载应用

b）在资源实例页面，选择“分布式事务Seata”，单击 + > 新增资源实例。

![image](https://user-images.githubusercontent.com/79617492/211256900-a5b27738-d7b4-48ba-b641-838487156abb.png)

##### 图1-9 单击新增资源实例

c）在新增资源实例页面上填写相关信息，然后单击提交。

```
说明：

c1）资源实例里对应的配置要跟registry.conf文件里的配置一致。

c2）可以在资源实例里选择对应的注册中心和对应配置中心填写相关字段信息。
```

![image](https://user-images.githubusercontent.com/79617492/211256914-f6086e4e-01f2-4e44-afcf-174216174984.png)

##### 图1-10 填写相关信息

#### 7.7.1.2.3 数据库里创建undo_log表

a）在对应的数据库中创建undo_log表。

```
说明：

a1）undo_log是innodb引擎的一种日志，在事务的修改记录之前，会把该记录原来的值先保存起来再做修改，以便修改过程中出错后能够恢复原值或者被其它的事务读取，当事务回滚或者数据库崩溃时，可以利用undo_log来进行回滚数据。

a2）不同的数据库类型创建undo_log表的SQL语句可在 https://github.com/seata/seata/tree/master/script/client/at/db 里查看。

a3）该表必须手动创建，且表名为undo_log，如果不存在该表，则无法回滚。
```

![image](https://user-images.githubusercontent.com/79617492/211257080-121a82be-04ef-483e-ab8a-d54740d004e0.png)

##### 图1-11 如果不存在该表，则无法回滚

#### 7.7.1.2.4 开启分布式事务

a）新增嵌入式中间件资源实例，在“是否支持分布式事务Seata”上选择为 “true”，然后单击提交即可。

```
说明：

a1）关于新增嵌入式中间件资源实例请参考文档“操作指南/15资源实例/1新增资源实例/新增嵌入式中间件资源”。

a2）是否支持分布式事务Seata为true时，支持分布式事务，为false时则不支持。若不支持分布式事务，则在开启事务组件中打开“是否开启分布式事务”开关也无效。

a3）当前支持分布式事务Seata的中间件有嵌入式中间件、数据库中间件选择嵌入式中间件、动态数据库中间件组件。
```

![image](https://user-images.githubusercontent.com/79617492/211257100-1e3d00ce-ca7b-45ed-bc3f-22552f92091e.png)

##### 图1-12 选择为 “true”

b）在SQL管理页面里，SQL组的中间件选择 “测试嵌入式中间件”。

##### 说明：因为“测试嵌入式中间件”资源实例支持分布式事务，所以当SQL组的中间件选择该资源实例时，该SQL组里的所有SQL都支持分布式事务。

![image](https://user-images.githubusercontent.com/79617492/211257128-5f35d947-eb94-4996-b7c2-77395b9fa25d.png)

##### 图1-13 选择 “测试嵌入式中间件”

c）新增测试接口一，打开“开启事务”组件的是否开启分布式事务开关。

```
说明：

c1）测试接口一为举例接口，逻辑：开启分布式事务，对数据库表里新增数据，最后提交事务，输出结果。

c2）分布式事务超时时间：默认时间为60s，可进行自定义设置，如果在超时时间内未提交事务，则会自动进行回滚。
```

![image](https://user-images.githubusercontent.com/79617492/211257147-4b6f6a43-7390-455e-b930-b92ef9ba1752.png)

##### 图1-14 打开开启分布式事务开关

d）新增测试接口二，打开“开启事务”组件的是否开启分布式事务开关。

##### 说明：测试接口二为举例接口，逻辑：开启分布式事务，对数据库表里新增数据，然后HTTP组件调用测试接口一，最后提交事务，输出结果。

![image](https://user-images.githubusercontent.com/79617492/211257166-c32d484a-ac26-42a8-9636-0cb763ba28fd.png)

##### 图1-15 打开开启分布式事务开关

e）选中“HTTP组件”，然后单击未选中记录。


```
说明：

e1）关于HTTP组件的使用请参考文档“组件使用/通信组件/HTTP组件的使用”。

e2）如果HTTP中调用的是其它项目或其它服务的接口，则该项目也要同时添加分布式事务Seata资源实例，且填写的数据要保持一致，具体可参考2.3.2添加分布式事务Seata资源实例章节。

e3）当前使用HTTP组件调用其它服务接口举例，也可以使用FeignClient组件，可以调用同项目接口，也可以调用其它项目接口。
```

![image](https://user-images.githubusercontent.com/79617492/211257186-13aace6e-5b17-4a77-bf5c-165f3e0700f6.png)

##### 图1-16 单击未选中记录

f）在填写数据页面，填写调用“测试接口一”的请求地址和其他信息后，打开是否抛出异常开关，然后单击提交。

##### 说明：当HTTP组件调用其它服务接口出现异常时，需要将异常抛出，然后当前事务就会进行回滚。

![image](https://user-images.githubusercontent.com/79617492/211257211-033a998c-59d3-4143-bb56-b27ef295e141.png)

##### 图1-17 打开是否抛出异常开关

g）发布接口，然后执行接口测试用例，查看响应内容。

##### 说明：测试接口二使用HTTP组件调用了测试接口一，且两个接口都开启了分布式事务，所以只要其中一个接口出现异常时，两个接口的SQL数据都会自动回滚，若其中一个接口没有开启分布式事务，则另一个接口异常时，不会回滚未开启分布式事务的接口数据。

![image](https://user-images.githubusercontent.com/79617492/211257235-e65ffac4-0ab8-4394-91df-bb229e8e4705.png)

##### 图1-18 执行接口测试用例
