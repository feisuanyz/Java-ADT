### 7. 进阶指南

#### 7.7 事务

#### 7.7.1 分布式事务Seata

分布式事务是指在分布式环境下由不同的服务之间通过网络远程协作完成事务，而Seata是一款开源的分布式事务解决方案。平台支持分布式事务Seata，在调用不同服务的接口可以一起提交事务和回滚，保持数据的准确性，有助于提供高性能和简单易用的分布式事务服务。

#### 7.7.1.1 步骤概述

a）配置分布式事务Seata

b）添加分布式事务Seata资源实例

c）数据库里创建undo_log表

d）开启分布式事务

#### 7.7.1.2 操作步骤

#### 7.7.1.2.1 配置分布式事务Seata

a）以配置nacos举例，打开nacos服务地址，在配置中心中新建配置，填写配置信息，单击发布。

```
说明：

a1）nacos服务需要用户自行搭建，新建配置的内容可参考https://github.com/seata/seata/tree/develop/script/config-center的config.text配置文件。

a2）从Seatea 1.4.2版本开始，已支持从一个Nacos dataId中获取所有配置信息。
```

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/7.%20%E8%BF%9B%E9%98%B6%E6%8C%87%E5%8D%97/7.%20%E4%BA%8B%E5%8A%A1/image.png)

##### 图1-1 在配置中心中新建配置

b）在 https://seata.io/zh-cn/blog/download.html 里下载seata文件。

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/7.%20%E8%BF%9B%E9%98%B6%E6%8C%87%E5%8D%97/7.%20%E4%BA%8B%E5%8A%A1/1-2.png)

##### 图1-2 下载seata文件

c）解压文件夹，然后在conf文件夹下找到 “registry.conf”文件。

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/7.%20%E8%BF%9B%E9%98%B6%E6%8C%87%E5%8D%97/7.%20%E4%BA%8B%E5%8A%A1/1-3.png)

##### 图1-3 找到 “registry.conf”文件

d）打开 “registry.conf”文件，根据需求修改对应配置相关字段的信息。

##### 说明：关于更多详细配置可参考官方文档“ https://seata.io/zh-cn/docs/overview/what-is-seata.html ”，这里以配置nacos举例，则nacos的相关字段信息要和对应的注册中心或配置中心上的保持一致。

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/7.%20%E8%BF%9B%E9%98%B6%E6%8C%87%E5%8D%97/7.%20%E4%BA%8B%E5%8A%A1/1-4.png)

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/7.%20%E8%BF%9B%E9%98%B6%E6%8C%87%E5%8D%97/7.%20%E4%BA%8B%E5%8A%A1/1-5.png)

##### 图1-4/5 修改对应配置相关字段的信息

e）在bin文件夹下双击 “seata-server.bat”。

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/7.%20%E8%BF%9B%E9%98%B6%E6%8C%87%E5%8D%97/7.%20%E4%BA%8B%E5%8A%A1/1-6.png)

##### 图1-6 双击 “seata-server.bat”

f）启动成功。

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/7.%20%E8%BF%9B%E9%98%B6%E6%8C%87%E5%8D%97/7.%20%E4%BA%8B%E5%8A%A1/1-7.png)

##### 图1-7 启动成功

#### 7.7.1.2.2 添加分布式事务Seata资源实例

a）在项目加载项页面，单击资源 > 添加分布式事务Seata资源实例，然后单击加载应用。

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/7.%20%E8%BF%9B%E9%98%B6%E6%8C%87%E5%8D%97/7.%20%E4%BA%8B%E5%8A%A1/1-8.png)

##### 图1-8 加载应用

b）在资源实例页面，选择“分布式事务Seata”，单击 + > 新增资源实例。

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/7.%20%E8%BF%9B%E9%98%B6%E6%8C%87%E5%8D%97/7.%20%E4%BA%8B%E5%8A%A1/1-9.png)

##### 图1-9 单击新增资源实例

c）在新增资源实例页面上填写相关信息，然后单击提交。

```
说明：

c1）资源实例里对应的配置要跟registry.conf文件里的配置一致。

c2）可以在资源实例里选择对应的注册中心和对应配置中心填写相关字段信息。
```

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/7.%20%E8%BF%9B%E9%98%B6%E6%8C%87%E5%8D%97/7.%20%E4%BA%8B%E5%8A%A1/1-10.png)

##### 图1-10 填写相关信息

#### 7.7.1.2.3 数据库里创建undo_log表

a）在对应的数据库中创建undo_log表。

```
说明：

a1）undo_log是innodb引擎的一种日志，在事务的修改记录之前，会把该记录原来的值先保存起来再做修改，以便修改过程中出错后能够恢复原值或者被其它的事务读取，当事务回滚或者数据库崩溃时，可以利用undo_log来进行回滚数据。

a2）不同的数据库类型创建undo_log表的SQL语句可在 https://github.com/seata/seata/tree/master/script/client/at/db 里查看。

a3）该表必须手动创建，且表名为undo_log，如果不存在该表，则无法回滚。
```

![输入图片说明](../../../../images/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/1.%20%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%20-%20%E6%9B%B4%E6%96%B0%E6%97%A5%E6%9C%9F%20-%202022.10.08/7.%20%E8%BF%9B%E9%98%B6%E6%8C%87%E5%8D%97/7.%20%E4%BA%8B%E5%8A%A1/1-11.png)

##### 图1-11 如果不存在该表，则无法回滚

#### 7.7.1.2.4 开启分布式事务
