### 8. 高阶专题

#### 8.5 自定义资源实例

通过自行定义的资源实例，先上传至平台进行审核，只有平台审核通过的资源实例，才能上架该平台使用。

#### 8.5.1 前提条件

自定义资源实例需要下载如下Demo工程包和加载项开发包，具体如下：

a）资源实例Demo工程包下载地址：demo-resource.zip

b）下载加载项开发包：在(后端)全自动开发平台中，单击右上角下载加载项开发包，如图5-1所示。

![image](https://user-images.githubusercontent.com/79617492/211453740-f4297e98-f9e9-438b-811c-fcb064ee41d1.png)

##### 图5-1 下载加载项开发包

#### 8.5.2 操作步骤

a）在Pom文件中增加依赖包。

包名：com.feisuanyz.flow.resource

类名：Resource

```
<dependency>
     <groupId>com.feisuanyz.flow</groupId>
     <artifactId>flow-core-cmpt</artifactId>
     <version>${version}</version>
     <scope>provided</scope>
     <systemPath>${开发辅助工具路径}/flow-core-cmpt-${version}.jar</systemPath>
</dependency>
```

b）实现Resource接口。

包名：com.feisuanyz.flow.resource

类名：Resource

实现方法：

```
/**
 * 创建资源实例
 * @param parameters 参数
 * @return 实例对象
 * @throws ResourceException
 */
T newInstance(ResourceParameter parameters) throws ResourceException;
```

c）获取资源实例。

平台提供了工具类ResourceUtil.java调用相应的方法，获取到的对象是Object，强转成对应的实例对象即可。

方法示例如下：

```
/**
 * 获取资源实例
 * @param resourceName 资源名称
 * @return 资源实例
 */
public static Object getResourceInstance(String resourceName){
    return getResourceInstance(ProcessInfoHolder.get().getProjectId(),resourceName);
}

/**
 * 获取资源实例
 * @param projectId 项目编号
 * @param resourceName 资源名称
 * @return 资源实例
 */
public static Object getResourceInstance(String projectId,String resourceName){
    try {
        return getResourceInstanceMethod.invoke(null, projectId, resourceName);
    } catch (Exception e) {
        throw new ResourceException(ExceptionUtils.getFullStackTrace(e));
    }
}
```

d）定义资源实例方式。

资源实例的定义需要按照以下xml格式进行描述，文件名必须为resources.xml，然后存放到项目中的resources目录下，一起打成Jar包上传到平台即可。

正确示例如下：

```
<?xml version="1.0" encoding="UTF-8"?>

<resourceTypes>
    <resourceType name="DalResource"
               implClass="com.feisuanyz.flow.resource.dal.DalResource"
               description="DAL资源，返回Map，key为dal对应的ID,Value为IDALService： 用于操作数据库表">
        <!-- format 可选值有：properties、xml、json、yml、yaml、txt-->
        <configGroup format="properties" description="dal配置，属性文件（key、value）配置格式">
            <configItem key = "zkAddress" description="zk地址" />
            <configItem key = "group" description="dal组" />
            <configItem key = "timeout" description="超时时间" />
            <configItem key = "retries" description="重试次数" />
        </configGroup>
    </resourceType>
</resourceTypes>
```

一个xml文件可以定义多个资源，<resourceType>xxx</resourceType>表示一个组件的定义，属性有：

d1）name：名称

d2）implClass：组件的实现类全路径，这个字段很重要，关系到资源实例能否成功在平台执行。

d3）description：描述，尽可能全面的介绍组件的功能，方便其他用户使用。

d4）configGroup：配置组，该资源实例所需的配置信息进行规范的定义，属性有：

```
- format：配置组格式，可选值有：properties、xml、json、yml、yaml、txt
- description：配置组描述。
- configItem：配置项，属性值有：
- key：配置项名称
- description：描述
```

##### 说明：当format格式为xml、json、yml、yaml、txt，配置项只有一个，并且key的名称只能是content。

e）对自定义的资源实例打jar包，生成如下类似文件。

```
demo-resource-1.0.0.jar

demo-resource-1.0.0.pom
```

f）将生成的demo-resource-1.0.0.jar和demo-resource-1.0.0.pom压缩成一个zip包上传到平台即可。

##### 说明：如何导入自定义资源，请参见《SoFlu（后端）全自动开发平台教程第4.3.3.2节：自定义导入资源》。
