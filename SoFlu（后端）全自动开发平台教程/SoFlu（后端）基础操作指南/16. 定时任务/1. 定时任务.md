### 1. 定时任务

#### 1.1 新增定时任务模块

本节主要介绍如何在项目中新增定时任务模块的具体操作过程。

##### 1.1.1 操作步骤

a）进入全自动开发平台功能模块界面，选择“定时任务”功能模块，如图1-1所示：

![image](https://user-images.githubusercontent.com/79617492/171143381-b56c9e39-acb2-4351-abee-1031465479dd.png)

##### 图1-1 功能模块界面

b）单击“新增定时任务模块”，系统弹出新增定时任务模块页面，如图1-2所示：

![image](https://user-images.githubusercontent.com/79617492/171143399-8cc6165e-71b6-4a10-9f8d-ba31d67c0a02.png)

##### 图1-2 单击新增按钮

![image](https://user-images.githubusercontent.com/79617492/171143423-48417dd1-7dc8-4fe0-a8c4-4634d944ca80.png)

##### 图1-3 新增定时任务模块

c）输入定时任务模块的名称和描述，单击“确定”，可以看到定时模块新增成功，如图1-4所示：

![image](https://user-images.githubusercontent.com/79617492/171143443-bf2b9785-2ef5-4557-b2fe-0e20b8e7296f.png)

##### 图1-4 新增成功

#### 1.2 新增定时任务

本节主要介绍如何在项目中新增定时任务的具体操作过程。

##### 1.2.1 操作步骤

a）选中定时任务模块，单击“+”按钮，选择“新增定时任务”，如图1-5所示：

![image](https://user-images.githubusercontent.com/79617492/171143489-10e3a6a6-5fce-4094-afbd-a1fcaff40265.png)

##### 图1-5 新增定时任务

b）系统显示新增定时任务页面，输入定时任务的名称及描述，如图1-6所示：

![image](https://user-images.githubusercontent.com/79617492/171143513-4fd8961d-78c4-4cfc-9794-9baaecea019c.png)

##### 图1-6 设置定时任务

c）单击“生成Cron”，系统显示“生成Cron”页面，请根据实际需求配置生成Cron的条件，即定时任务机制，如图1-7所示：

![image](https://user-images.githubusercontent.com/79617492/171143558-09324251-31d9-4029-a6be-ff2a41fde188.png)

##### 图1-7 生成Cron

d）单击“确定”，选择“下一步”，添加入参的参数，如图1-8所示：

![image](https://user-images.githubusercontent.com/79617492/171143590-3f916ba0-bc0c-4236-837d-bbfa0c42d925.png)

##### 图1-8 添加入参参数

e）单击“提交”，完成入参配置，选择“模型”进入模型配置页面，如图1-9所示：

![image](https://user-images.githubusercontent.com/79617492/171143646-83c76614-a5e8-454a-bc2a-5d4bcb3d40d9.png)

##### 图1-9 模型配置页面

f）单击“进入模型编辑”，在窗体视图添加定时任务操作流程，如图1-10所示：

![image](https://user-images.githubusercontent.com/79617492/171143679-54ff019a-0c0a-40a6-b31c-8ed8b6e858e0.png)

##### 图1-10 添加操作流程

g）单击“执行任务”，测试定时任务功能，如图1-11所示：

![image](https://user-images.githubusercontent.com/79617492/171143702-b626a28a-6673-4a85-9000-f1a5eac11623.png)

##### 图1-11 测试定时任务功能

h）查看定时任务测试结果，如图1-12所示：

![image](https://user-images.githubusercontent.com/79617492/171143733-cd767f6b-2658-4043-9fca-887a97896f7c.png)

##### 图1-12 查看测试结果

i）单击“响应结果”列显示的链接查看具体的结果信息，如图1-13所示：

![image](https://user-images.githubusercontent.com/79617492/171143755-f94158e7-3340-4c70-9c96-3391afe261cb.png)

##### 图1-13 查看具体结果信息

j）单击“启动任务”，完成启动定时任务，如图1-14所示：

![image](https://user-images.githubusercontent.com/79617492/171143788-e2ec26bd-c569-4aa7-93f4-1f32eb78f7f1.png)

##### 图1-14 完成启动定时任务

#### 1.3 复制、导入、导出定时任务

系统提供该功能，用户可以在同项目中复制、或者在不同项目之间导入导出定时任务，以减少频繁添加公共的定时任务。

##### 前提条件

您需要拥有“定时任务”模块的权限。

权限由系统管理员在“用户权限中心”系统中配置。

##### 1.3.1 操作步骤：复制定时任务

a）进入“定时任务”模块，选中需复制的定时任务，单击旁边的三个点符号，或进入编辑定时任务页面，选择“复制定时任务”，如图1-15、图1-16所示：

![image](https://user-images.githubusercontent.com/79617492/171143816-78355b1a-17d6-4b09-982c-d8c2b1bdcde5.png)

##### 图1-15 定时任务列表

![image](https://user-images.githubusercontent.com/79617492/171143839-4a0473d8-e7c6-4b6a-b8d5-92aa2c18803b.png)

##### 图1-16 编辑定时任务页面

b）系统弹出“是否确定复制定时任务”提示，单击“确定”，如图1-17所示：

![image](https://user-images.githubusercontent.com/79617492/171143866-365d279f-5101-4d99-b09f-ceed6e7b2535.png)

##### 图1-17 弹出提示框

c）修改定时任务的名称，单击“提交”即可，如图1-18所示：

![image](https://user-images.githubusercontent.com/79617492/171143896-a7ab654a-36ce-42f4-8863-b82492b69e04.png)

##### 图1-18 修改子流程名称

d）复制后的定时任务会显示在列表中，如图1-19所示：

![image](https://user-images.githubusercontent.com/79617492/171143916-8364d2fe-4e0c-4aaf-8e67-8af45842f205.png)

##### 图1-19 复制成功

##### 1.3.2 操作步骤：导入定时任务

a）进入“定时任务”模块，单击“新增定时任务”旁边的三个点按钮选择“导入定时任务”，如图1-20所示：

![image](https://user-images.githubusercontent.com/79617492/171143935-d24dff23-88d6-4919-909a-6218f111a628.png)

##### 图1-20 导入定时任务

b）系统显示导入定时任务页面，选择需上传的定时任务JSON文件，单击“导入”，如图1-21所示：

![image](https://user-images.githubusercontent.com/79617492/171143962-cedf8f02-31cd-48e9-b6c8-c2b26da7f8ab.png)

##### 图1-21 选择定时任务JOSN文件

##### 注意：若需导入的定时任务在系统中已存在时，您需要选择“覆盖原有定时任务”才可导入，原有定时任务将会自动删除。

c）系统提示“导入定时任务成功”。

##### 1.3.3 操作步骤：导出定时任务

a）进入“定时任务”模块，单击“新增定时任务”旁边的三个点按钮选择“导出定时任务”，如图1-22所示：

![image](https://user-images.githubusercontent.com/79617492/171143995-5119865d-15c8-43a4-990a-252cc2074708.png)

##### 图1-22 选择导出定时任务

b）系统显示导出定时任务页面，输入导出定时任务JSON文件的文件名（若未输入则自动生成），如图1-23所示：

![image](https://user-images.githubusercontent.com/79617492/171144033-38ed8f39-39ce-4bea-a962-88121008e1b6.png)

##### 图1-23 导出定时任务页面

c）勾选需导出的定时任务，单击“确定”即可，需导出的定时任务JSON文件会在页面下方自动下载。

#### 1.4 对定时任务进行集群部署

定时任务支持集群部署，即支持部署在多台服务器上。每个定时任务只会在其中一台服务器上执行，若出现执行某一定时任务所在服务器故障的情况，其它正常的服务器则会继续执行该定时任务。本节主要介绍如何对定时任务进行集群部署。

##### 1.4.1 操作步骤

a）对定时任务进行集群部署与项目部署操作基本一致，项目部署操作详见[《SoFlu（后端）基础操作指南第8.1.15节：项目部署》](https://github.com/feisuanyz/SoFlu-adp/blob/main/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%85%A8%E8%87%AA%E5%8A%A8%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0%E6%95%99%E7%A8%8B/SoFlu%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C%E6%8C%87%E5%8D%97/8.%20%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/1.%20%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86.md#115-%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2)。

略有不同的地方在于，若您想要对定时任务进行集群部署，则需要在原有` application.yml `模板文件的基础上添加如下内容：


```
# 用户定时任务配置
custom-job:
    # 是否集群模式(默认为false，不进行配置时也为false)
    clustered: true
    # 线程池配置
    threadPool:
        threadCount: 15
    # 用户自定义集群数据源
    customDataSource:
        driverClassName: com.mysql.jdbc.Driver
        url: jdbc:mysql://x.x.x.x:3306/database_name?characterEncoding=UTF-8
        username: root
        password: 123456
        maxActive: 20
```

##### 注意：

a1）其中的“x.x.x.x”为服务器地址，请根据实际情况填写。

a2）以上是单台服务器对定时任务进行集群部署的流程，多台服务器的部署流程是一样的。但需要注意的是，当多台服务器分别进行集群部署时，它们的数据库地址必须相同，即它们都指向同一个数据库。

a3）定时任务会在已启动的服务器上执行，若有多台服务器同时启动，定时任务的执行情况则随机分布。
